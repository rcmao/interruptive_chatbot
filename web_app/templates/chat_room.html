<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聊天房间</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: radial-gradient(1200px 600px at 20% -10%, rgba(99, 102, 241, 0.08), transparent),
                        radial-gradient(1000px 500px at 80% 0%, rgba(147, 51, 234, 0.06), transparent),
                        #36393f;
            color: #dcddde;
            height: 100vh;
            overflow: hidden;
        }

        .chat-container {
            display: flex;
            height: 100vh;
        }

        /* 侧边栏 */
        .sidebar {
            width: 240px;
            background: rgba(47,49,54,0.6);
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255,255,255,0.1);
            position: relative;
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12), inset 0 1px 0 rgba(255,255,255,0.06);
        }

        .sidebar-header {
            padding: 16px;
            background: rgba(47,49,54,0.6);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            backdrop-filter: blur(16px);
        }

        .room-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .room-name {
            font-weight: 600;
            font-size: 16px;
        }

        .room-description {
            font-size: 12px;
            color: #96989d;
            margin-top: 4px;
        }

        .sidebar-nav {
            padding: 8px;
        }

        .nav-item {
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #96989d;
            transition: all 0.2s;
            text-decoration: none;
            border: 1px solid transparent;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.08);
            color: #dcddde;
        }

        .nav-item.active {
            background: rgba(255,255,255,0.18);
            color: white;
            border-color: rgba(255,255,255,0.22);
            box-shadow: 0 8px 20px rgba(0,0,0,0.18), inset 0 1px 0 rgba(255,255,255,0.22);
        }

        /* 主聊天区域 */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #36393f;
            position: relative;
        }

        .chat-header {
            padding: 16px 20px;
            background: rgba(47,49,54,0.6);
            border-bottom: 1px solid rgba(255,255,255,0.12);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12), inset 0 1px 0 rgba(255,255,255,0.08);
            backdrop-filter: blur(18px);
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .channel-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .channel-hash {
            color: #96989d;
            font-size: 20px;
            font-weight: 600;
        }

        .channel-name {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
        }

        .channel-description {
            font-size: 12px;
            color: #96989d;
            margin-left: 8px;
        }

        .chat-header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-icon {
            color: #96989d;
            font-size: 16px;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .header-icon:hover {
            color: #dcddde;
            background: #40444b;
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.08);
            border-radius: 10px;
            padding: 6px 12px;
            gap: 8px;
            min-width: 200px;
            border: 1px solid rgba(255,255,255,0.12);
            backdrop-filter: blur(12px);
        }

        .search-bar input {
            background: transparent;
            border: none;
            color: #dcddde;
            font-size: 14px;
            outline: none;
            width: 100%;
        }

        .search-bar input::placeholder {
            color: #96989d;
        }

        .chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 16px;
            padding: 8px 16px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }

        .message:hover {
            background-color: rgba(255, 255, 255, 0.02);
        }

        .message-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #5865f2;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .message-author {
            font-weight: 600;
            color: #dcddde;
            font-size: 15px;
        }

        .message-timestamp {
            font-size: 12px;
            color: #72767d;
            font-weight: 400;
        }

        .message-text {
            color: #dcddde;
            line-height: 1.5;
            font-size: 15px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .intervention-message {
            background: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin-top: 8px;
            border-radius: 4px;
        }

        .intervention-message .strategy {
            font-weight: 600;
            color: #ffc107;
            margin-bottom: 4px;
            font-size: 12px;
        }

        .chat-input {
            padding: 16px;
            background: #36393f;
            border-top: 1px solid #202225;
        }

        .input-container {
            display: flex;
            align-items: flex-end;
            background: rgba(64, 68, 75, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 12px;
            padding: 12px;
            position: relative;
            gap: 8px;
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12), inset 0 1px 0 rgba(255,255,255,0.08);
        }

        .input-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .input-action-btn {
            color: rgba(255,255,255,0.8);
            font-size: 16px;
            cursor: pointer;
            padding: 8px;
            border-radius: 10px;
            transition: all 0.2s;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            backdrop-filter: blur(12px);
        }

        .input-action-btn:hover {
            color: #fff;
            background: rgba(255,255,255,0.12);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.18);
        }

        .input-right-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .message-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #dcddde;
            font-size: 14px;
            resize: none;
            min-height: 20px;
            max-height: 120px;
            outline: none;
            margin: 0 8px;
        }

        .message-input::placeholder {
            color: #72767d;
        }

        .send-button {
            background: #5865f2;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        .send-button:hover {
            background: #4752c4;
        }

        .send-button:disabled {
            background: #40444b;
            cursor: not-allowed;
        }

        /* 当前用户信息样式 */
        .current-user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: #2f3136;
            border-radius: 4px;
            border: 1px solid #202225;
            min-width: 120px;
            margin-right: 8px;
            flex-shrink: 0;
        }

        .current-user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #5865f2;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
            font-size: 12px;
            flex-shrink: 0;
        }

        .current-user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .current-user-details {
            flex: 1;
            min-width: 0;
        }

        .current-user-name {
            font-weight: 600;
            font-size: 13px;
            color: #dcddde;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .current-user-status {
            font-size: 11px;
            color: #43b581;
            font-weight: 500;
            line-height: 1.2;
        }

        /* 统计面板 */
        .stats-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: #2f3136;
            border-radius: 8px;
            padding: 16px;
            width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .stats-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: #dcddde;
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .stats-label {
            color: #96989d;
        }

        .stats-value {
            color: #dcddde;
            font-weight: 500;
        }

        /* 用户列表 */
        .users-panel {
            width: 240px;
            background: #2f3136;
            border-left: 1px solid #202225;
            display: flex;
            flex-direction: column;
        }

        .users-header {
            padding: 16px 20px;
            background: #292b2f;
            border-bottom: 1px solid #202225;
            font-weight: 600;
            color: #dcddde;
            font-size: 14px;
        }

        .users-header .online-count {
            color: #96989d;
            font-size: 12px;
            margin-top: 4px;
            font-weight: normal;
        }

        .user-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            color: #dcddde;
            border-bottom: 1px solid #23272a;
        }

        .user-item:hover {
            background: #40444b;
        }

        /* 在线用户样式 */
        .user-item.online {
            opacity: 1;
        }

        .user-item.online .user-avatar {
            filter: none;
        }

        .user-item.online .user-name {
            color: #dcddde;
        }

        .user-item.online .user-status {
            color: #43b581;
        }

        /* 离线用户灰度效果 */
        .user-item.offline {
            opacity: 0.6;
        }

        .user-item.offline .user-avatar {
            filter: grayscale(100%);
        }

        .user-item.offline .user-name {
            color: #96989d;
        }

        .user-item.offline .user-status {
            color: #747f8d;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #5865f2;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
            font-size: 16px;
            position: relative;
        }

        .user-avatar:hover {
            transform: scale(1.1);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .user-tooltip.show {
            opacity: 1;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-status {
            font-size: 12px;
            color: #96989d;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            position: absolute;
            bottom: 2px;
            right: 2px;
            border: 2px solid #2f3136;
        }

        .status-indicator.online {
            background: #43b581;
        }

        .status-indicator.offline {
            background: #747f8d;
        }

        .status-indicator.idle {
            background: #faa61a;
        }

        .status-indicator.dnd {
            background: #f04747;
        }

        /* 响应式设计 */
        @media (max-width: 1200px) {
            .users-panel {
                width: 200px;
            }
        }
        
        @media (max-width: 900px) {
            .users-panel {
                width: 180px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
        }

        /* 侧边栏用户信息样式 */
        .sidebar-user-info {
            position: absolute;
            bottom: 0;
            left: 16px;
            right: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: rgba(47,49,54,0.6);
            border-top: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px 12px 0 0;
            backdrop-filter: blur(14px);
        }

        .sidebar-user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #5865f2;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }

        .sidebar-user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .sidebar-user-details {
            flex: 1;
            min-width: 0;
        }

        .sidebar-user-name {
            font-weight: 600;
            font-size: 14px;
            color: #dcddde;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .sidebar-user-status {
            font-size: 12px;
            color: #43b581;
            font-weight: 500;
            line-height: 1.2;
        }
        
        /* 语言切换按钮样式（与首页一致的玻璃质感分段控件） */
        .language-switcher {
            display: flex;
            gap: 6px;
            padding: 6px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 16px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow:
                0 8px 24px rgba(0,0,0,0.12),
                inset 0 1px 0 rgba(255,255,255,0.12);
        }

        .lang-btn {
            background: transparent;
            border: none;
            border-radius: 12px;
            padding: 8px 14px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.2px;
            transition: all 0.25s ease;
            color: rgba(255, 255, 255, 0.92);
        }

        .lang-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.18);
        }

        .lang-btn.active {
            background: rgba(255, 255, 255, 0.18);
            color: #fff;
            box-shadow:
                0 8px 26px rgba(0,0,0,0.2),
                inset 0 1px 0 rgba(255,255,255,0.25);
        }

        /* 导出按钮样式 */
        .export-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(88, 101, 242, 0.8);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s ease;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 4px 12px rgba(88, 101, 242, 0.3);
        }

        .export-btn:hover {
            background: rgba(88, 101, 242, 1);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(88, 101, 242, 0.4);
        }

        .export-btn:active {
            transform: translateY(0);
        }

        .export-btn i {
            font-size: 14px;
        }

        .export-btn.loading {
            background: rgba(88, 101, 242, 0.6);
            cursor: not-allowed;
        }

        .export-btn.loading i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="room-info">
                    <div>
                        <div class="room-name" id="roomName">加载中...</div>
                        <div class="room-description" id="roomDescription">加载中...</div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-nav">
                <a href="/rooms" class="nav-item">
                    <i class="fas fa-door-open"></i>
                    <span id="roomManagementNav">房间管理</span>
                </a>
                <a href="/" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span id="returnHomeNav">返回首页</span>
                </a>
            </div>
            
            <!-- 当前用户信息 -->
            <div class="sidebar-user-info">
                <div class="sidebar-user-avatar" id="sidebarUserAvatar">
                    <span id="sidebarUserInitial">A</span>
                </div>
                <div class="sidebar-user-details">
                    <div class="sidebar-user-name" id="sidebarUserName">加载中...</div>
                    <div class="sidebar-user-status" id="sidebarUserStatus">在线</div>
                </div>
            </div>
        </div>

        <!-- 主聊天区域 -->
        <div class="chat-area">
            <div class="chat-header">
                <div class="chat-header-left">
                    <div class="channel-info">
                        <span class="channel-hash">#</span>
                        <span class="channel-name" id="currentChannel"></span>
                        <span class="channel-description" id="channelDescription"></span>
                    </div>
                </div>
                <div class="chat-header-right">
                    <div class="search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="搜索消息..." />
                    </div>
                    <!-- 导出聊天记录按钮 -->
                    <button class="export-btn" onclick="exportChatHistory()" title="导出聊天记录">
                        <i class="fas fa-download"></i>
                        <span id="exportBtnText">导出</span>
                    </button>
                    <!-- 语言切换按钮 -->
                    <div class="language-switcher">
                        <button class="lang-btn" onclick="switchLanguage('zh')" id="zhBtn">中文</button>
                        <button class="lang-btn" onclick="switchLanguage('en')" id="enBtn">English</button>
                    </div>
                    <i class="fas fa-bell-slash header-icon" title="静音通知"></i>
                    <i class="fas fa-bell header-icon" title="通知设置"></i>
                    <i class="fas fa-thumbtack header-icon" title="置顶消息"></i>
                    <i class="fas fa-users header-icon" title="成员列表" onclick="toggleMemberList()"></i>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div style="text-align: center; padding: 40px; color: #96989d;">
                    <i class="fas fa-comments" style="font-size: 48px; margin-bottom: 20px;"></i>
                    <p id="startChattingText">开始聊天吧！</p>
                </div>
            </div>

            <div class="chat-input">
                <div class="input-container">
                    <div class="input-actions">
                        <i class="fas fa-plus input-action-btn" title="添加附件"></i>
                    </div>
                    
                    <textarea 
                        class="message-input" 
                        id="messageInput" 
                        placeholder="Message #general"
                        rows="1"
                        onkeydown="handleKeyDown(event)"
                    ></textarea>
                    <div class="input-right-actions">
                        <button class="send-button" onclick="sendMessage()" id="sendButton">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
        </div>

            </div>
            <!-- 统计面板 - 暂时隐藏 -->
            <!--
    <div class="stats-panel" id="statsPanel">
        <div class="stats-title">实时统计</div>
        <div class="stats-item">
            <span class="stats-label">总消息数:</span>
            <span class="stats-value" id="totalMessages">0</span>
        </div>
        <div class="stats-item">
            <span class="stats-label">女性消息:</span>
            <span class="stats-value" id="femaleMessages">0 (0%)</span>
        </div>
        <div class="stats-item">
            <span class="stats-label">男性消息:</span>
            <span class="stats-value" id="maleMessages">0 (0%)</span>
        </div>
        <div class="stats-item">
            <span class="stats-label">检测到打断:</span>
            <span class="stats-value" id="interruptions">0次</span>
        </div>
        <div class="stats-item">
            <span class="stats-label">干预次数:</span>
            <span class="stats-value" id="interventions">0次</span>
                </div>
            </div>
            -->
        </div>

        <!-- 用户列表侧边栏 -->
        <div class="users-panel" id="usersPanel">
            <div class="users-header" id="usersHeader">
                成员列表
                <div class="online-count" id="onlineCount">在线 - 0 | 离线 - 0</div>
            </div>
            <div class="user-list" id="userList">
                <!-- 用户列表将在这里动态加载 -->
            </div>
        </div>
    </div>

    <script>
        let socket = null;
        let currentUser = null;
        let currentRoomId = null;
        let currentLanguage = 'zh';
        let translations = {};
        let stats = {
            totalMessages: 0,
            femaleMessages: 0,
            maleMessages: 0,
            interruptions: 0,
            interventions: 0
        };

        // 获取房间ID
        const roomId = window.location.pathname.split('/').pop();

        // 初始化
        window.onload = function() {
            console.log('页面开始初始化...');
            
            // 检查登录状态
            const token = localStorage.getItem('token');
            if (!token) {
                console.log('未找到登录token，跳转到首页');
                window.location.href = '/';
                return;
            }

            // 加载保存的语言设置
            const savedLanguage = localStorage.getItem('language') || 'zh';
            console.log('加载保存的语言设置:', savedLanguage);
            
            // 先设置语言，再加载其他内容
            switchLanguage(savedLanguage).then(() => {
                console.log('语言切换完成，开始加载其他内容');
                
                currentRoomId = roomId;
                console.log('当前房间ID:', currentRoomId);
                
                // 获取用户信息
                loadUserInfo();
                
                // 加载房间信息
                loadRoomInfo();
                
                // 连接WebSocket
                connectWebSocket();
                
                // 加载初始数据
                loadMessages();
                loadUsers();
                loadStats();
                
                // 加载保存的风格并同步TKI控制面板
                loadSavedInterventionStyle().then(() => {
                    // 确保风格显示在页面加载时正确显示
                    setTimeout(() => {
                        loadSavedInterventionStyle();
                    }, 1000);
                });
                
                // 页面初始化完成后，定期刷新成员列表
                setInterval(() => {
                    console.log('定时刷新成员列表...');
                    loadUsers();
                }, 5000); // 每5秒刷新一次
                
                // 全局鼠标事件监听器，确保tooltip正确隐藏
                document.addEventListener('mouseover', (event) => {
                    // 如果鼠标不在用户头像上，隐藏tooltip
                    if (!event.target.closest('.user-avatar')) {
                        hideUserTooltip();
                    }
                });
                
                console.log('页面初始化完成');
            });
        };

        // 页面事件监听器
        window.addEventListener('beforeunload', () => {
            console.log('页面即将关闭，离开房间');
            if (socket) {
                socket.emit('leave_room', { room: String(currentRoomId) });
            }
        });

        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                console.log('页面显示，确保已加入房间并同步消息');
                if (socket) {
                    socket.emit('join_room', { room: String(currentRoomId) });
                }
                // 回到前台时同步一次历史消息，避免错过后台期间的消息
                loadMessages();
            }
        });

        // 加载用户信息
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/user/info', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                if (response.ok) {
                    currentUser = await response.json();
                    updateCurrentUserDisplay();
                }
            } catch (error) {
                console.error('加载用户信息失败:', error);
            }
        }

        // 更新当前用户显示
        function updateCurrentUserDisplay() {
            if (!currentUser) return;
            
            const sidebarAvatarElement = document.getElementById('sidebarUserAvatar');
            const sidebarNameElement = document.getElementById('sidebarUserName');
            const sidebarInitialElement = document.getElementById('sidebarUserInitial');
            
            if (sidebarAvatarElement && sidebarNameElement && sidebarInitialElement) {
                // 更新用户名
                const displayName = currentUser.display_name || currentUser.username;
                sidebarNameElement.textContent = displayName;
                
                // 更新头像
                if (currentUser.avatar) {
                    sidebarAvatarElement.innerHTML = `<img src="${currentUser.avatar}" alt="${displayName}">`;
                } else {
                    // 如果没有头像，显示用户名首字母
                    const initial = displayName.charAt(0).toUpperCase();
                    sidebarInitialElement.textContent = initial;
                    sidebarAvatarElement.innerHTML = `<span id="sidebarUserInitial">${initial}</span>`;
                }
                
                console.log('侧边栏用户信息已更新:', displayName);
            }
        }

        // 加载房间信息
        async function loadRoomInfo() {
            try {
                const response = await fetch(`/api/rooms/${currentRoomId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const room = await response.json();
                    console.log('房间信息:', room);
                    
                    // 更新房间名称
                    const roomNameElement = document.querySelector('.room-name');
                    if (roomNameElement) {
                        roomNameElement.textContent = room.name;
                    }
                    
                    // 更新房间描述 - 使用翻译
                    const roomDescriptionElement = document.querySelector('.room-description');
                    if (roomDescriptionElement) {
                        if (room.description && room.description.trim()) {
                            roomDescriptionElement.textContent = room.description;
                        } else {
                            roomDescriptionElement.textContent = t('no_description');
                        }
                    }
                } else if (response.status === 404) {
                    // 房间不存在，跳转到错误页面
                    window.location.href = '/rooms';
                } else {
                    console.error('加载房间信息失败:', response.status);
                }
            } catch (error) {
                console.error('加载房间信息失败:', error);
            }
        }

        // 连接WebSocket
        function connectWebSocket() {
            console.log('开始连接WebSocket...');
            const token = localStorage.getItem('token');
            
            // 统一连接到8080端口的WebSocket服务器
            // 不管当前页面在哪个端口，都连到8080
            const wsBase = `${window.location.protocol}//${window.location.hostname}:8080`;
            console.log('WebSocket连接地址:', wsBase);
            
            socket = io(wsBase, { 
                query: { token },
                transports: ['websocket', 'polling'],
                upgrade: true,
                rememberUpgrade: true
            });
            
            socket.on('connect', () => {
                console.log('WebSocket连接成功，房间ID:', currentRoomId);
                console.log('Socket ID:', socket.id);
                console.log('连接到的服务器:', wsBase);
                console.log('连接状态:', socket.connected);
                console.log('传输方式:', socket.io.engine.transport.name);
                
                // 立即加入房间
                socket.emit('join_room', { room: String(currentRoomId) });
                console.log('已发送加入房间事件');
                
                // 发送一个测试事件验证连接
                setTimeout(() => {
                    console.log('发送测试事件...');
                    socket.emit('test', { message: '前端测试消息' });
                }, 1000);
            });

            socket.on('disconnect', () => {
                console.log('WebSocket连接断开');
            });

            socket.on('connect_error', (error) => {
                console.error('WebSocket连接错误:', error);
            });

            // 消息监听器
            socket.on('message', (data) => {
                console.log('收到消息:', data);
                console.log('消息类型:', typeof data);
                console.log('消息内容:', JSON.stringify(data));
                console.log('消息房间:', data.room, '当前房间:', currentRoomId);
                
                // 防御：仅处理当前房间的消息
                if (String(data.room || currentRoomId) !== String(currentRoomId)) {
                    console.log('消息房间不匹配，跳过');
                    return;
                }

                console.log('消息房间匹配，开始渲染...');
                // 使用addMessage函数来正确显示消息（包含去重）
                addMessage(data);
                console.log('addMessage函数调用完成');
            });

            socket.on('user_joined', (data) => {
                console.log('收到user_joined', data);
                console.log('立即调用loadUsers()...');
                // 立即重新加载用户列表
                loadUsers();
                console.log('loadUsers()调用完成');
            });

            socket.on('user_left', (data) => {
                console.log('收到user_left', data);
                console.log('立即调用loadUsers()...');
                // 立即重新加载用户列表
                loadUsers();
                console.log('loadUsers()调用完成');
            });

            socket.on('intervention', (data) => {
                console.log('收到干预消息:', data);
                addIntervention(data);
                updateStats();
            });

            // 测试事件监听器（已移除弹窗）
            socket.on('test', (data) => {
                console.log('收到测试消息:', data);
            });
            
            // TKI风格更新事件监听器（房间内广播）
            socket.on('tki_style_updated', (data) => {
                console.log('收到TKI风格更新:', data);
                updateTKIStyleDisplay(data);
                // 同时更新当前风格显示
                updateCurrentInterventionStyle(data.style);
            });

            // 干预风格更新事件监听器（全局广播）
            socket.on('intervention_style_updated', (data) => {
                console.log('收到干预风格更新:', data);
                updateCurrentInterventionStyle(data.style);
                // 同时同步TKI控制面板（仅管理员可见）
                const tkiStyleSelect = document.getElementById('tkiStyle');
                if (tkiStyleSelect && currentUser && currentUser.role === 'admin') {
                    tkiStyleSelect.value = data.style;
                    onTKIStyleChange();
                }
            });

            console.log('WebSocket事件监听器已设置完成');
        }

        // 发送消息
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content) return;

            console.log('开始发送消息:', content);
            console.log('当前用户:', currentUser);
            console.log('WebSocket状态:', socket ? '已连接' : '未连接');
            console.log('房间ID:', currentRoomId);
            console.log('Socket ID:', socket ? socket.id : '无');

            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;

            try {
                const messageData = {
                    content: content,
                    gender: currentUser.gender || 'unknown',
                    client_id: `${Date.now()}-${Math.random().toString(36).slice(2)}`
                };

                console.log('消息数据:', messageData);

                // 通过WebSocket发送消息
                if (socket) {
                    const emitData = {
                        room: String(currentRoomId),
                        message: messageData
                    };
                    console.log('发送WebSocket事件:', emitData);
                    // 乐观更新：先本地加入一条消息
                    addMessage({
                        id: `local-${messageData.client_id}`,
                        content: messageData.content,
                        author: (currentUser.display_name || currentUser.username),
                        avatar: currentUser.avatar || '',
                        timestamp: new Date().toISOString(),
                        has_interruption: false,
                        interruption_type: null,
                        intervention_applied: false,
                        client_id: messageData.client_id
                    });
                    socket.emit('send_message', emitData);
                    input.value = '';
                    console.log('消息已发送到WebSocket');
                    
                    // 等待一下看看是否收到回复
                    setTimeout(() => {
                        console.log('3秒后检查是否收到消息...');
                    }, 3000);
                } else {
                    console.error('WebSocket未连接');
                }
            } catch (error) {
                console.error('发送消息失败:', error);
            } finally {
                sendButton.disabled = false;
            }
        }

        // 处理键盘事件
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // 添加消息到界面
        function addMessage(data) {
            try {
            const messagesContainer = document.getElementById('chatMessages');
                if (!messagesContainer) {
                    console.error('找不到消息容器元素');
                    return;
                }

            // 如果已经渲染过相同client_id的消息则跳过，避免重复
            if (data.client_id && messagesContainer.querySelector(`[data-client-id="${data.client_id}"]`)) {
                return;
            }
            
            // 清除欢迎消息
            if (messagesContainer.children.length === 1 && 
                messagesContainer.children[0].querySelector('.fa-comments')) {
                messagesContainer.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            if (data.client_id) {
                messageDiv.dataset.clientId = data.client_id;
            }
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
                
                // 使用用户头像或默认头像
                if (data.avatar && data.avatar.trim() !== '') {
                    const img = document.createElement('img');
                    img.src = data.avatar;
                    img.alt = data.author;
                    img.onerror = function() {
                        // 如果头像加载失败，显示用户名首字母
            avatar.textContent = data.author.charAt(0).toUpperCase();
                    };
                    avatar.appendChild(img);
                } else {
                    // 没有头像时显示用户名首字母
                    avatar.textContent = data.author.charAt(0).toUpperCase();
                }
            
            const content = document.createElement('div');
            content.className = 'message-content';
            
            const header = document.createElement('div');
            header.className = 'message-header';
            
            const author = document.createElement('span');
            author.className = 'message-author';
            author.textContent = data.author;
            
            const timestamp = document.createElement('span');
            timestamp.className = 'message-timestamp';
                // 显示本地时间，格式为 HH:MM:SS
                const localTime = new Date(data.timestamp).toLocaleTimeString('zh-CN', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                timestamp.textContent = localTime;
            
            header.appendChild(author);
            header.appendChild(timestamp);
            
            const text = document.createElement('div');
            text.className = 'message-text';
            text.textContent = data.content;
            
            content.appendChild(header);
            content.appendChild(text);
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // 更新统计
            stats.totalMessages++;
            updateStats();
            } catch (error) {
                console.error('添加消息时出错:', error);
            }
        }

        // 添加干预消息
        function addIntervention(data) {
            const messagesContainer = document.getElementById('chatMessages');
            const interventionDiv = document.createElement('div');
            interventionDiv.className = 'message';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = '<i class="fas fa-robot"></i>';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            
            const header = document.createElement('div');
            header.className = 'message-header';
            
            const author = document.createElement('span');
            author.className = 'message-author';
            author.textContent = 'TKI干预机器人';
            
            const timestamp = document.createElement('span');
            timestamp.className = 'message-timestamp';
            // 显示本地时间，格式为 HH:MM:SS
            const localTime = new Date(data.timestamp).toLocaleTimeString('zh-CN', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            timestamp.textContent = localTime;
            
            header.appendChild(author);
            header.appendChild(timestamp);
            
            const interventionContent = document.createElement('div');
            interventionContent.className = 'intervention-message';
            
            const strategy = document.createElement('div');
            strategy.className = 'strategy';
            strategy.textContent = `干预策略: ${data.strategy}`;
            
            const text = document.createElement('div');
            text.className = 'message-text';
            text.textContent = data.text;
            
            interventionContent.appendChild(strategy);
            interventionContent.appendChild(text);
            
            content.appendChild(header);
            content.appendChild(interventionContent);
            
            interventionDiv.appendChild(avatar);
            interventionDiv.appendChild(content);
            
            messagesContainer.appendChild(interventionDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // 更新统计
            stats.interventions++;
            updateStats();
        }

        // 加载消息历史
        async function loadMessages() {
            try {
                const response = await fetch(`/api/rooms/${currentRoomId}/messages`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const messages = await response.json();
                    const messagesContainer = document.getElementById('chatMessages');
                    messagesContainer.innerHTML = '';
                    
                    messages.forEach(msg => {
                        addMessage(msg);
                    });
                }
            } catch (error) {
                console.error('加载消息失败:', error);
            }
        }

        // 加载房间成员列表
        async function loadUsers() {
            console.log('开始加载用户列表，房间ID:', currentRoomId);
            try {
                // 添加时间戳防止缓存
                const timestamp = new Date().getTime();
                const response = await fetch(`/api/rooms/${currentRoomId}/members?t=${timestamp}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Cache-Control': 'no-cache'
                    }
                });
                
                console.log('API响应状态:', response.status);
                console.log('API响应头:', response.headers);
                
                if (response.ok) {
                    const members = await response.json();
                    console.log('加载到的成员:', members);
                    console.log('成员数量:', members.length);
                    console.log('成员详情:', JSON.stringify(members, null, 2));
                    
                    displayUsers(members);
                } else {
                    console.error('加载房间成员失败:', response.status, response.statusText);
                    const responseText = await response.text();
                    console.error('错误响应内容:', responseText);
                    // 显示错误信息
                    const userList = document.getElementById('userList');
                    if (userList) {
                        userList.innerHTML = '<div style="padding: 20px; text-align: center; color: #f04747; font-size: 14px;">加载成员失败</div>';
                    } else {
                        console.error('找不到userList元素');
                    }
                }
            } catch (error) {
                console.error('加载房间成员失败:', error);
                // 显示错误信息
                const userList = document.getElementById('userList');
                if (userList) {
                    userList.innerHTML = '<div style="padding: 20px; text-align: center; color: #f04747; font-size: 14px;">网络错误</div>';
                } else {
                    console.error('找不到userList元素');
                }
            }
        }

        // 显示房间成员列表
        function displayUsers(members) {
            console.log('开始显示用户列表，成员数量:', members.length);
            const userList = document.getElementById('userList');
            if (!userList) {
                console.error('找不到userList元素');
                return;
            }
            
            console.log('找到userList元素，开始处理成员数据');
            
            // 简化逻辑：只要在房间中就显示为在线
            const onlineUsers = members.filter(member => member.is_online);
            const offlineUsers = members.filter(member => !member.is_online);
            
            console.log('在线用户数:', onlineUsers.length, '离线用户数:', offlineUsers.length);
            
            // 更新在线人数显示
            const onlineCountElement = document.getElementById('onlineCount');
            if (onlineCountElement) {
                onlineCountElement.innerHTML = `${t('members')}<div class="online-count">${t('online')} - ${onlineUsers.length} | ${t('offline')} - ${offlineUsers.length}</div>`;
                console.log('已更新在线人数显示');
            } else {
                console.error('找不到onlineCount元素');
            }
            
            // 清空用户列表
            userList.innerHTML = '';
            console.log('已清空用户列表');
            
            // 如果没有用户，显示提示信息
            if (members.length === 0) {
                console.log('没有成员，显示空状态');
                const emptyMessage = document.createElement('div');
                emptyMessage.style.cssText = 'padding: 20px; text-align: center; color: #96989d; font-size: 14px;';
                emptyMessage.innerHTML = `<i class="fas fa-users" style="font-size: 24px; margin-bottom: 8px; display: block;"></i>${t('no_members')}`;
                userList.appendChild(emptyMessage);
                return;
            }
            
            // 添加在线用户
            if (onlineUsers.length > 0) {
                console.log('添加在线用户标题');
                const onlineHeader = document.createElement('div');
                onlineHeader.className = 'user-section-header';
                onlineHeader.textContent = `${t('online')} - ${onlineUsers.length}`;
                onlineHeader.style.cssText = 'padding: 8px 16px; font-size: 12px; color: #96989d; font-weight: 600; background: #2f3136; border-bottom: 1px solid #202225;';
                userList.appendChild(onlineHeader);
                
                onlineUsers.forEach(member => {
                    addUserToList(member, true);
                });
            }
            
            // 添加离线用户
            if (offlineUsers.length > 0) {
                console.log('添加离线用户标题');
                const offlineHeader = document.createElement('div');
                offlineHeader.className = 'user-section-header';
                offlineHeader.textContent = `${t('offline')} - ${offlineUsers.length}`;
                offlineHeader.style.cssText = 'padding: 8px 16px; font-size: 12px; color: #96989d; font-weight: 600; background: #2f3136; border-bottom: 1px solid #202225;';
                userList.appendChild(offlineHeader);
                
                offlineUsers.forEach(member => {
                    addUserToList(member, false);
                });
            }
        }

        // 添加用户到列表
        function addUserToList(member, isOnline) {
            console.log('添加用户到列表:', member, '在线状态:', isOnline);
            const userList = document.getElementById('userList');
            if (!userList) {
                console.error('找不到userList元素');
                return;
            }
            
            const userDiv = document.createElement('div');
            userDiv.className = `user-item ${isOnline ? 'online' : 'offline'}`;
            userDiv.dataset.userId = member.user_id;
            
            const displayName = member.display_name || member.username;
            const statusClass = isOnline ? 'online' : 'offline';
            const statusText = isOnline ? t('online') : t('offline');
            
            console.log('用户信息:', {
                username: member.username,
                displayName: displayName,
                isOnline: isOnline,
                statusClass: statusClass,
                statusText: statusText,
                lastActivity: member.last_activity,
                isInRoom: member.is_in_room
            });
            
            // 转义特殊字符，防止XSS
            const safeUsername = member.username.replace(/[<>'"]/g, '');
            const safeDisplayName = displayName.replace(/[<>'"]/g, '');
            
            userDiv.innerHTML = `
                    <div class="user-avatar" 
                     onmouseenter="showUserTooltip(event, '${safeUsername}', '${safeDisplayName}', '${member.gender || 'unknown'}', '${member.role || 'member'}')"
                     onmouseleave="hideUserTooltip()"
                     onmouseout="hideUserTooltip()">
                    ${member.avatar ? `<img src="${member.avatar}" alt="${safeUsername}">` : safeUsername.charAt(0).toUpperCase()}
                    <div class="status-indicator ${statusClass}"></div>
                    </div>
                    <div class="user-info">
                    <div class="user-name">${safeDisplayName}</div>
                    <div class="user-status">${statusText}</div>
                    </div>
            `;
            
            userList.appendChild(userDiv);
            console.log('已添加用户到列表:', member.username);
        }

        // 实时更新用户状态
        function updateUserStatus(userId, isOnline) {
            const userItem = document.querySelector(`[data-user-id="${userId}"]`);
            if (userItem) {
                const statusClass = isOnline ? 'online' : 'offline';
                const statusText = isOnline ? t('online') : t('offline');
                
                // 更新用户项样式
                userItem.className = `user-item ${statusClass}`;
                
                // 更新状态指示器
                const statusIndicator = userItem.querySelector('.status-indicator');
                if (statusIndicator) {
                    statusIndicator.className = `status-indicator ${statusClass}`;
                }
                
                // 更新状态文本
                const statusTextElement = userItem.querySelector('.user-status');
                if (statusTextElement) {
                    statusTextElement.textContent = statusText;
                }
                
                console.log(`用户 ${userId} 状态更新为: ${isOnline ? '在线' : '离线'}`);
            }
        }

        // 定期刷新用户状态
        function startUserStatusRefresh() {
            // 每5秒刷新一次用户状态
            setInterval(() => {
                if (socket && socket.connected) {
                    console.log('定期刷新用户状态...');
                    loadUsers();
                }
            }, 5000);
        }

        // 页面初始化完成后启动状态刷新
        window.addEventListener('load', () => {
            startUserStatusRefresh();
        });

        // 显示用户提示
        function showUserTooltip(event, username, displayName, gender, role) {
            const tooltip = document.createElement('div');
            tooltip.className = 'user-tooltip';
            tooltip.id = 'userTooltip';
            
            const genderText = gender === 'male' ? `♂ ${t('male')}` : gender === 'female' ? `♀ ${t('female')}` : `? ${t('unknown')}`;
            const roleText = role === 'admin' ? t('admin') : t('member');
            const nameText = displayName ? `${displayName} (${username})` : username;
            
            tooltip.innerHTML = `
                <div><strong>${nameText}</strong></div>
                <div>${genderText}</div>
                <div>${roleText}</div>
            `;
            
            document.body.appendChild(tooltip);
            
            // 定位提示框
            const rect = event.target.getBoundingClientRect();
            tooltip.style.left = rect.left + 'px';
            tooltip.style.top = (rect.top - tooltip.offsetHeight - 10) + 'px';
            
            // 显示提示框
            setTimeout(() => tooltip.classList.add('show'), 10);
        }

        // 隐藏用户提示
        function hideUserTooltip() {
            const tooltip = document.getElementById('userTooltip');
            if (tooltip) {
                tooltip.classList.remove('show');
                setTimeout(() => {
                    if (tooltip && tooltip.parentNode) {
                        tooltip.remove();
                    }
                }, 200);
            }
        }

        // 添加用户到列表
        function addUser(userData) {
            const userList = document.getElementById('userList');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-item';
            userDiv.innerHTML = `
                <div class="user-avatar">${userData.username.charAt(0).toUpperCase()}</div>
                <div class="user-info">
                    <div class="user-name">${userData.username}</div>
                    <div class="user-status">在线</div>
                </div>
                <div class="status-indicator"></div>
            `;
            userList.appendChild(userDiv);
            updateOnlineCount();
        }

        // 从列表中移除用户
        function removeUser(userId) {
            const userItems = document.querySelectorAll('.user-item');
            userItems.forEach(item => {
                if (item.dataset.userId === userId) {
                    item.remove();
                }
            });
            updateOnlineCount();
        }

        // 更新在线人数
        function updateOnlineCount() {
            const userItems = document.querySelectorAll('.user-item');
            const count = userItems.length;
            document.getElementById('onlineCount').textContent = `${count}人在线`;
            document.getElementById('userCount').textContent = count;
        }

        // 加载统计数据
        async function loadStats() {
            try {
                const response = await fetch(`/api/stats/${currentRoomId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    stats = data;
                    updateStats();
                }
            } catch (error) {
                console.log('加载统计失败:', error);
                // 使用默认统计
                stats = {
                    totalMessages: 0,
                    femaleMessages: 0,
                    maleMessages: 0,
                    interruptions: 0,
                    interventions: 0
                };
            }
        }

        // 更新统计显示
        function updateStats() {
            try {
                const totalMessagesEl = document.getElementById('totalMessages');
                const femaleMessagesEl = document.getElementById('femaleMessages');
                const maleMessagesEl = document.getElementById('maleMessages');
                const interruptionsEl = document.getElementById('interruptions');
                const interventionsEl = document.getElementById('interventions');
                
                if (totalMessagesEl) totalMessagesEl.textContent = stats.totalMessages;
                if (femaleMessagesEl) femaleMessagesEl.textContent = 
                `${stats.femaleMessages} (${stats.femalePercentage || 0}%)`;
                if (maleMessagesEl) maleMessagesEl.textContent = 
                `${stats.maleMessages} (${stats.malePercentage || 0}%)`;
                if (interruptionsEl) interruptionsEl.textContent = `${stats.interruptions}次`;
                if (interventionsEl) interventionsEl.textContent = `${stats.interventions}次`;
            } catch (error) {
                console.log('更新统计显示时出错:', error);
            }
        }

        // 切换成员列表显示
        function toggleMemberList() {
            const usersPanel = document.getElementById('usersPanel');
            if (usersPanel.style.display === 'none') {
                usersPanel.style.display = 'flex'; // Changed from 'block' to 'flex'
            } else {
                usersPanel.style.display = 'none';
            }
        }

        // TKI风格选择变化处理函数
        function onTKIStyleChange() {
            const tkiStyle = document.getElementById('tkiStyle').value;
            const descriptionEl = document.getElementById('tkiStyleDescription');
            const confirmButton = document.getElementById('tkiConfirmButton');
            
            // 定义各种风格的描述
            const styleDescriptions = {
                'none': '无插话 - AI不会进行任何干预',
                'collaborating': '协作型 - 整合各方观点，推动共识，平衡支持女性表达与维护群体和谐',
                'accommodating': '迁就型 - 优先维护和谐，用温和语气为女性缓颊，避免冲突',
                'competing': '竞争型 - 强势捍卫女性表达权，正面对抗偏见，可能激化冲突',
                'compromising': '妥协型 - 设置公平讨论机制，保障发言机会，不参与观点评价',
                'avoiding': '回避型 - 岔开矛盾话题，表面轻松，实则削弱女性表达机会'
            };
            
            // 更新描述
            if (descriptionEl) {
                descriptionEl.textContent = styleDescriptions[tkiStyle] || '选择TKI插话风格来控制AI的干预行为';
            }
            
            // 启用确认按钮
            if (confirmButton) {
                confirmButton.disabled = false;
                confirmButton.textContent = `确认更换为: ${document.getElementById('tkiStyle').options[document.getElementById('tkiStyle').selectedIndex].text}`;
            }
        }
        
        // TKI风格确认函数
        function confirmTKIStyleChange() {
            const tkiStyle = document.getElementById('tkiStyle').value;
            const confirmButton = document.getElementById('tkiConfirmButton');
            
            // 禁用确认按钮，防止重复点击
            if (confirmButton) {
                confirmButton.disabled = true;
                confirmButton.textContent = '正在更新...';
            }
            
            // 发送风格选择到后端
            if (socket) {
                socket.emit('tki_style_change', {
                    room: String(currentRoomId),
                    style: tkiStyle
                });
                console.log('TKI风格已确认更改为:', tkiStyle);
            }
            
            // 立即更新当前风格显示
            updateCurrentInterventionStyle(tkiStyle);
            
            // 显示确认消息
            showNotification(`TKI风格已成功设置为: ${document.getElementById('tkiStyle').options[document.getElementById('tkiStyle').selectedIndex].text}`);
            
            // 重置确认按钮
            setTimeout(() => {
                if (confirmButton) {
                    confirmButton.textContent = '确认更换TKI插话风格';
                    confirmButton.disabled = false;
                }
            }, 2000);
        }
        
        // 更新TKI风格显示
        function updateTKIStyleDisplay(data) {
            const tkiStyleSelect = document.getElementById('tkiStyle');
            const descriptionEl = document.getElementById('tkiStyleDescription');
            
            if (tkiStyleSelect && descriptionEl) {
                // 更新选择框
                tkiStyleSelect.value = data.style;
                
                // 更新描述
                descriptionEl.textContent = data.description;
                
                console.log('TKI风格显示已更新:', data.style);
            }
        }
        
        // 更新当前干预风格显示
        function updateCurrentInterventionStyle(style) {
            const styleIndicatorDot = document.getElementById('styleIndicatorDot');
            const currentStyleText = document.getElementById('currentStyleText');
            
            // 风格颜色映射
            const styleColors = {
                'none': '#747f8d',      // 灰色
                'auto': '#747f8d',      // 灰色
                'collaborating': '#5865f2',  // 蓝色
                'accommodating': '#57f287',  // 绿色
                'competing': '#ed4245',      // 红色
                'compromising': '#faa61a',   // 橙色
                'avoiding': '#eb459e'        // 粉色
            };
            
            // 风格显示名称映射
            const styleNames = {
                'none': '无插话',
                'auto': '自动选择',
                'collaborating': '协作型',
                'accommodating': '迁就型',
                'competing': '竞争型',
                'compromising': '妥协型',
                'avoiding': '回避型'
            };
            
            // 更新颜色和文本
            if (styleIndicatorDot) {
                styleIndicatorDot.style.background = styleColors[style] || styleColors['collaborating'];
            }
            
            if (currentStyleText) {
                currentStyleText.textContent = styleNames[style] || styleNames['collaborating'];
            }
            
            // 保存到本地存储
            localStorage.setItem('currentInterventionStyle', style);
            
            console.log(`干预风格已更新为: ${styleNames[style]}`);
        }

        // 加载保存的干预风格
        function loadSavedInterventionStyle() {
            return new Promise((resolve) => {
                // 首先从服务器获取当前风格
                fetch('/api/admin/current-intervention-style')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const serverStyle = data.style || 'collaborating';
                        updateCurrentInterventionStyle(serverStyle);
                        
                        // 同步TKI控制面板的选择（仅管理员可见）
                        const tkiStyleSelect = document.getElementById('tkiStyle');
                        if (tkiStyleSelect && currentUser && currentUser.role === 'admin') {
                            tkiStyleSelect.value = serverStyle;
                            // 触发描述更新
                            onTKIStyleChange();
                        }
                        
                        // 同时更新本地存储
                        localStorage.setItem('currentInterventionStyle', serverStyle);
                        
                        console.log(`从服务器加载干预风格: ${serverStyle}`);
                        resolve(serverStyle);
                    })
                    .catch(error => {
                        console.error('从服务器加载风格失败:', error);
                        // 如果服务器请求失败，使用本地存储的备份
                        const savedStyle = localStorage.getItem('currentInterventionStyle');
                        if (savedStyle) {
                            updateCurrentInterventionStyle(savedStyle);
                            // 同步TKI控制面板的选择（仅管理员可见）
                            const tkiStyleSelect = document.getElementById('tkiStyle');
                            if (tkiStyleSelect && currentUser && currentUser.role === 'admin') {
                                tkiStyleSelect.value = savedStyle;
                                onTKIStyleChange();
                            }
                        } else {
                            // 默认风格
                            updateCurrentInterventionStyle('collaborating');
                            // 同步TKI控制面板的选择（仅管理员可见）
                            const tkiStyleSelect = document.getElementById('tkiStyle');
                            if (tkiStyleSelect && currentUser && currentUser.role === 'admin') {
                                tkiStyleSelect.value = 'collaborating';
                                onTKIStyleChange();
                            }
                        }
                        resolve(savedStyle || 'collaborating');
                    });
            });
        }

        // 显示通知消息
        function showNotification(message) {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #5865f2;
                color: white;
                padding: 12px 16px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            // 添加动画样式
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // 3秒后自动移除
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // 语言切换功能
        async function switchLanguage(lang) {
            console.log('开始切换语言到:', lang);
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            
            // 更新按钮状态
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.getElementById(lang + 'Btn');
            if (activeBtn) {
                activeBtn.classList.add('active');
                console.log('语言按钮状态已更新');
            }
            
            // 加载翻译
            await loadTranslations(lang);
            console.log('翻译加载完成');
            
            // 更新界面文本
            updateUIText();
            
            // 重新加载用户列表以更新状态文本
            setTimeout(() => {
                loadUsers();
            }, 100);
            
            console.log('语言切换完成');
        }

        // 加载翻译
        async function loadTranslations(lang) {
            try {
                const response = await fetch(`/api/translations/${lang}`);
                if (response.ok) {
                    translations = await response.json();
                } else {
                    translations = getBuiltInTranslations(lang);
                }
            } catch (error) {
                console.error('加载翻译失败:', error);
                translations = getBuiltInTranslations(lang);
            }
        }

        // 获取内置翻译
        function getBuiltInTranslations(lang) {
            const translations = {
                zh: {
                    page_title: '聊天房间',
                    data_statistics: '数据统计',
                    room_management: '房间管理',
                    return_home: '返回首页',
                    search_messages: '搜索消息...',
                    mute_notifications: '静音通知',
                    notification_settings: '通知设置',
                    pin_message: '置顶消息',
                    member_list: '成员列表',
                    start_chatting: '开始聊天吧！',
                    message_placeholder: 'Message #general',
                    add_attachment: '添加附件',
                    gift: '礼物',
                    gif: 'GIF',
                    sticker: '贴纸',
                    emoji: '表情',
                    game_activity: '游戏活动',
                    send_message: '发送消息',
                    members: '成员列表',
                    online: '在线',
                    offline: '离线',
                    no_members: '暂无成员',
                    no_description: '暂无描述',
                    loading_members_failed: '加载成员失败',
                    network_error: '网络错误',
                    male: '男性',
                    female: '女性',
                    unknown: '未知',
                    admin: '管理员',
                    member: '成员',
                    loading: '加载中...',
                    chinese: '中文',
                    english: 'English',
                    export: '导出',
                    export_chat_history: '导出聊天记录',
                    exporting: '导出中...',
                    export_success: '聊天记录导出成功！',
                    export_failed: '导出失败，请重试'
                },
                en: {
                    page_title: 'Chat Room',
                    data_statistics: 'Data Statistics',
                    room_management: 'Room Management',
                    return_home: 'Return Home',
                    search_messages: 'Search messages...',
                    mute_notifications: 'Mute notifications',
                    notification_settings: 'Notification settings',
                    pin_message: 'Pin message',
                    member_list: 'Member list',
                    start_chatting: 'Start chatting!',
                    message_placeholder: 'Message #general',
                    add_attachment: 'Add attachment',
                    gift: 'Gift',
                    gif: 'GIF',
                    sticker: 'Sticker',
                    emoji: 'Emoji',
                    game_activity: 'Game activity',
                    send_message: 'Send message',
                    members: 'Members',
                    online: 'Online',
                    offline: 'Offline',
                    no_members: 'No members',
                    no_description: 'No description',
                    loading_members_failed: 'Failed to load members',
                    network_error: 'Network error',
                    male: 'Male',
                    female: 'Female',
                    unknown: 'Unknown',
                    admin: 'Admin',
                    member: 'Member',
                    loading: 'Loading...',
                    chinese: '中文',
                    english: 'English',
                    export: 'Export',
                    export_chat_history: 'Export Chat History',
                    exporting: 'Exporting...',
                    export_success: 'Chat history exported successfully!',
                    export_failed: 'Export failed, please try again'
                }
            };
            return translations[lang] || translations.zh;
        }

        // 获取翻译文本
        function t(key) {
            return translations[key] || key;
        }

        // 导出聊天记录
        async function exportChatHistory() {
            const exportBtn = document.querySelector('.export-btn');
            const exportBtnText = document.getElementById('exportBtnText');
            
            // 设置加载状态
            exportBtn.classList.add('loading');
            exportBtn.disabled = true;
            exportBtnText.textContent = t('exporting');
            
            try {
                // 获取房间信息
                const roomResponse = await fetch(`/api/rooms/${currentRoomId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!roomResponse.ok) {
                    throw new Error('获取房间信息失败');
                }
                
                const room = await roomResponse.json();
                
                // 获取聊天记录
                const messagesResponse = await fetch(`/api/rooms/${currentRoomId}/messages`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!messagesResponse.ok) {
                    throw new Error('获取聊天记录失败');
                }
                
                const messages = await messagesResponse.json();
                
                // 生成导出内容
                const exportContent = generateExportContent(room, messages);
                
                // 创建并下载文件
                downloadFile(exportContent, `chat_history_${room.name}_${new Date().toISOString().split('T')[0]}.txt`);
                
                // 显示成功消息
                showNotification(t('export_success'));
                
            } catch (error) {
                console.error('导出聊天记录失败:', error);
                showNotification(t('export_failed'));
            } finally {
                // 恢复按钮状态
                exportBtn.classList.remove('loading');
                exportBtn.disabled = false;
                exportBtnText.textContent = t('export');
            }
        }
        
        // 生成导出内容
        function generateExportContent(room, messages) {
            const now = new Date();
            const exportTime = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            let content = `聊天记录导出报告\n`;
            content += `================================\n\n`;
            content += `房间信息:\n`;
            content += `- 房间名称: ${room.name}\n`;
            content += `- 房间描述: ${room.description || '暂无描述'}\n`;
            content += `- 房间ID: ${room.id}\n`;
            content += `- 创建时间: ${new Date(room.created_at).toLocaleString('zh-CN')}\n`;
            content += `- 导出时间: ${exportTime}\n`;
            content += `- 总消息数: ${messages.length}\n\n`;
            content += `聊天记录:\n`;
            content += `================================\n\n`;
            
            if (messages.length === 0) {
                content += `暂无聊天记录\n`;
            } else {
                messages.forEach((message, index) => {
                    const messageTime = new Date(message.timestamp).toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    
                    content += `[${index + 1}] ${messageTime}\n`;
                    content += `发送者: ${message.author}\n`;
                    content += `内容: ${message.content}\n`;
                    
                    // 如果有干预信息，也包含进去
                    if (message.has_interruption) {
                        content += `打断类型: ${message.interruption_type || '未知'}\n`;
                    }
                    if (message.intervention_applied) {
                        content += `已应用干预: 是\n`;
                    }
                    
                    content += `\n`;
                });
            }
            
            content += `\n================================\n`;
            content += `导出完成 - ${exportTime}\n`;
            
            return content;
        }
        
        // 下载文件
        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // 更新界面文本
        function updateUIText() {
            console.log('开始更新界面文本，当前语言:', currentLanguage);
            
            // 更新页面标题
            document.title = t('page_title');
            
            // 更新侧边栏导航
            const roomManagementNav = document.getElementById('roomManagementNav');
            const returnHomeNav = document.getElementById('returnHomeNav');
            if (roomManagementNav) roomManagementNav.textContent = t('room_management');
            if (returnHomeNav) returnHomeNav.textContent = t('return_home');
            
            // 更新用户状态
            const sidebarUserStatus = document.getElementById('sidebarUserStatus');
            if (sidebarUserStatus) sidebarUserStatus.textContent = t('online');
            
            // 更新房间描述 - 如果没有描述，显示翻译后的"暂无描述"
            const roomDescriptionElement = document.querySelector('.room-description');
            if (roomDescriptionElement && (!roomDescriptionElement.textContent || roomDescriptionElement.textContent === '暂无描述')) {
                roomDescriptionElement.textContent = t('no_description');
            }
            
            // 更新搜索框占位符
            const searchInput = document.querySelector('.search-bar input');
            if (searchInput) {
                searchInput.placeholder = t('search_messages');
                console.log('搜索框占位符已更新为:', t('search_messages'));
            }
            
            // 更新导出按钮文本
            const exportBtnText = document.getElementById('exportBtnText');
            if (exportBtnText) {
                exportBtnText.textContent = t('export');
            }
            
            // 更新图标标题
            const bellSlashIcon = document.querySelector('.fa-bell-slash');
            const bellIcon = document.querySelector('.fa-bell');
            const thumbtackIcon = document.querySelector('.fa-thumbtack');
            const usersIcon = document.querySelector('.fa-users');
            const exportBtn = document.querySelector('.export-btn');
            
            if (bellSlashIcon) bellSlashIcon.title = t('mute_notifications');
            if (bellIcon) bellIcon.title = t('notification_settings');
            if (thumbtackIcon) thumbtackIcon.title = t('pin_message');
            if (usersIcon) usersIcon.title = t('member_list');
            if (exportBtn) exportBtn.title = t('export_chat_history');
            
            // 更新欢迎消息
            const startChattingText = document.getElementById('startChattingText');
            if (startChattingText) {
                startChattingText.textContent = t('start_chatting');
            }
            
            // 更新输入框占位符
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.placeholder = t('message_placeholder');
                console.log('消息输入框占位符已更新为:', t('message_placeholder'));
            }
            
            // 更新输入操作按钮标题
            const plusIcon = document.querySelector('.fa-plus');
            const giftIcon = document.querySelector('.fa-gift');
            const imageIcon = document.querySelector('.fa-image');
            const stickyNoteIcon = document.querySelector('.fa-sticky-note');
            const smileIcon = document.querySelector('.fa-smile');
            const gamepadIcon = document.querySelector('.fa-gamepad');
            const sendButton = document.getElementById('sendButton');
            
            if (plusIcon) plusIcon.title = t('add_attachment');
            if (giftIcon) giftIcon.title = t('gift');
            if (imageIcon) imageIcon.title = t('gif');
            if (stickyNoteIcon) stickyNoteIcon.title = t('sticker');
            if (smileIcon) smileIcon.title = t('emoji');
            if (gamepadIcon) gamepadIcon.title = t('game_activity');
            if (sendButton) sendButton.title = t('send_message');
            
            // 更新成员列表标题
            const usersHeader = document.getElementById('usersHeader');
            if (usersHeader) {
                usersHeader.innerHTML = `${t('members')}<div class="online-count" id="onlineCount">${t('online')} - 0 | ${t('offline')} - 0</div>`;
                console.log('成员列表标题已更新为:', t('members'));
            }
            
            // 更新语言按钮文本
            const zhBtn = document.getElementById('zhBtn');
            const enBtn = document.getElementById('enBtn');
            if (zhBtn) zhBtn.innerHTML = ` ${t('chinese')}`;
            if (enBtn) enBtn.innerHTML = ` ${t('english')}`;
            
            console.log('界面文本更新完成，当前语言:', currentLanguage);
        }
    </script>
</body>
</html> 
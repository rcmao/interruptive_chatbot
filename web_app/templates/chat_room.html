<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©æˆ¿é—´</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #36393f;
            color: #dcddde;
            height: 100vh;
            overflow: hidden;
        }

        .chat-container {
            display: flex;
            height: 100vh;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 240px;
            background: #2f3136;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #202225;
            position: relative;
        }

        .sidebar-header {
            padding: 16px;
            background: #292b2f;
            border-bottom: 1px solid #202225;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .room-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .room-name {
            font-weight: 600;
            font-size: 16px;
        }

        .room-description {
            font-size: 12px;
            color: #96989d;
            margin-top: 4px;
        }

        .sidebar-nav {
            padding: 8px;
        }

        .nav-item {
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #96989d;
            transition: all 0.2s;
            text-decoration: none;
        }

        .nav-item:hover {
            background: #40444b;
            color: #dcddde;
        }

        .nav-item.active {
            background: #5865f2;
            color: white;
        }

        /* ä¸»èŠå¤©åŒºåŸŸ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #36393f;
            position: relative;
        }

        .chat-header {
            padding: 16px 20px;
            background: #36393f;
            border-bottom: 1px solid #40444b;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .channel-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .channel-hash {
            color: #96989d;
            font-size: 20px;
            font-weight: 600;
        }

        .channel-name {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
        }

        .channel-description {
            font-size: 12px;
            color: #96989d;
            margin-left: 8px;
        }

        .chat-header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-icon {
            color: #96989d;
            font-size: 16px;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .header-icon:hover {
            color: #dcddde;
            background: #40444b;
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: #40444b;
            border-radius: 4px;
            padding: 6px 12px;
            gap: 8px;
            min-width: 200px;
        }

        .search-bar input {
            background: transparent;
            border: none;
            color: #dcddde;
            font-size: 14px;
            outline: none;
            width: 100%;
        }

        .search-bar input::placeholder {
            color: #96989d;
        }

        .chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 16px;
            padding: 8px 16px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }

        .message:hover {
            background-color: rgba(255, 255, 255, 0.02);
        }

        .message-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #5865f2;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .message-author {
            font-weight: 600;
            color: #dcddde;
            font-size: 15px;
        }

        .message-timestamp {
            font-size: 12px;
            color: #72767d;
            font-weight: 400;
        }

        .message-text {
            color: #dcddde;
            line-height: 1.5;
            font-size: 15px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .intervention-message {
            background: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin-top: 8px;
            border-radius: 4px;
        }

        .intervention-message .strategy {
            font-weight: 600;
            color: #ffc107;
            margin-bottom: 4px;
            font-size: 12px;
        }

        .chat-input {
            padding: 16px;
            background: #36393f;
            border-top: 1px solid #202225;
        }

        .input-container {
            display: flex;
            align-items: flex-end;
            background: #40444b;
            border-radius: 8px;
            padding: 12px;
            position: relative;
            gap: 8px;
        }

        .input-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .input-action-btn {
            color: #96989d;
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .input-action-btn:hover {
            color: #dcddde;
            background: #4f545c;
        }

        .input-right-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .message-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #dcddde;
            font-size: 14px;
            resize: none;
            min-height: 20px;
            max-height: 120px;
            outline: none;
            margin: 0 8px;
        }

        .message-input::placeholder {
            color: #72767d;
        }

        .send-button {
            background: #5865f2;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        .send-button:hover {
            background: #4752c4;
        }

        .send-button:disabled {
            background: #40444b;
            cursor: not-allowed;
        }

        /* å½“å‰ç”¨æˆ·ä¿¡æ¯æ ·å¼ */
        .current-user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: #2f3136;
            border-radius: 4px;
            border: 1px solid #202225;
            min-width: 120px;
            margin-right: 8px;
            flex-shrink: 0;
        }

        .current-user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #5865f2;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
            font-size: 12px;
            flex-shrink: 0;
        }

        .current-user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .current-user-details {
            flex: 1;
            min-width: 0;
        }

        .current-user-name {
            font-weight: 600;
            font-size: 13px;
            color: #dcddde;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .current-user-status {
            font-size: 11px;
            color: #43b581;
            font-weight: 500;
            line-height: 1.2;
        }

        /* ç»Ÿè®¡é¢æ¿ */
        .stats-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: #2f3136;
            border-radius: 8px;
            padding: 16px;
            width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .stats-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: #dcddde;
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .stats-label {
            color: #96989d;
        }

        .stats-value {
            color: #dcddde;
            font-weight: 500;
        }

        /* ç”¨æˆ·åˆ—è¡¨ */
        .users-panel {
            width: 240px;
            background: #2f3136;
            border-left: 1px solid #202225;
            display: flex;
            flex-direction: column;
        }

        .users-header {
            padding: 16px 20px;
            background: #292b2f;
            border-bottom: 1px solid #202225;
            font-weight: 600;
            color: #dcddde;
            font-size: 14px;
        }

        .users-header .online-count {
            color: #96989d;
            font-size: 12px;
            margin-top: 4px;
            font-weight: normal;
        }

        .user-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            color: #dcddde;
            border-bottom: 1px solid #23272a;
        }

        .user-item:hover {
            background: #40444b;
        }

        /* åœ¨çº¿ç”¨æˆ·æ ·å¼ */
        .user-item.online {
            opacity: 1;
        }

        .user-item.online .user-avatar {
            filter: none;
        }

        .user-item.online .user-name {
            color: #dcddde;
        }

        .user-item.online .user-status {
            color: #43b581;
        }

        /* ç¦»çº¿ç”¨æˆ·ç°åº¦æ•ˆæœ */
        .user-item.offline {
            opacity: 0.6;
        }

        .user-item.offline .user-avatar {
            filter: grayscale(100%);
        }

        .user-item.offline .user-name {
            color: #96989d;
        }

        .user-item.offline .user-status {
            color: #747f8d;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #5865f2;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
            font-size: 16px;
            position: relative;
        }

        .user-avatar:hover {
            transform: scale(1.1);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .user-tooltip.show {
            opacity: 1;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-status {
            font-size: 12px;
            color: #96989d;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            position: absolute;
            bottom: 2px;
            right: 2px;
            border: 2px solid #2f3136;
        }

        .status-indicator.online {
            background: #43b581;
        }

        .status-indicator.offline {
            background: #747f8d;
        }

        .status-indicator.idle {
            background: #faa61a;
        }

        .status-indicator.dnd {
            background: #f04747;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .users-panel {
                width: 200px;
            }
        }
        
        @media (max-width: 900px) {
            .users-panel {
                width: 180px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
        }

        /* ä¾§è¾¹æ ç”¨æˆ·ä¿¡æ¯æ ·å¼ */
        .sidebar-user-info {
            position: absolute;
            bottom: 0;
            left: 16px;
            right: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: #292b2f;
            border-top: 1px solid #202225;
            border-radius: 8px 8px 0 0;
        }

        .sidebar-user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #5865f2;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }

        .sidebar-user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .sidebar-user-details {
            flex: 1;
            min-width: 0;
        }

        .sidebar-user-name {
            font-weight: 600;
            font-size: 14px;
            color: #dcddde;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .sidebar-user-status {
            font-size: 12px;
            color: #43b581;
            font-weight: 500;
            line-height: 1.2;
        }
        
        /* è¯­è¨€åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        .language-switcher {
            display: flex;
            gap: 8px;
        }

        .lang-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #5865f2;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            color: #dcddde;
        }

        .lang-btn:hover {
            background: #5865f2;
            color: white;
        }

        .lang-btn.active {
            background: #5865f2;
            color: white;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="room-info">
                    <div>
                        <div class="room-name" id="roomName">åŠ è½½ä¸­...</div>
                        <div class="room-description" id="roomDescription">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-nav">
                <a href="/rooms" class="nav-item">
                    <i class="fas fa-door-open"></i>
                    <span id="roomManagementNav">æˆ¿é—´ç®¡ç†</span>
                </a>
                <a href="/" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span id="returnHomeNav">è¿”å›é¦–é¡µ</span>
                </a>
            </div>
            
            <!-- å½“å‰ç”¨æˆ·ä¿¡æ¯ -->
            <div class="sidebar-user-info">
                <div class="sidebar-user-avatar" id="sidebarUserAvatar">
                    <span id="sidebarUserInitial">A</span>
                </div>
                <div class="sidebar-user-details">
                    <div class="sidebar-user-name" id="sidebarUserName">åŠ è½½ä¸­...</div>
                    <div class="sidebar-user-status" id="sidebarUserStatus">åœ¨çº¿</div>
                </div>
            </div>
        </div>

        <!-- ä¸»èŠå¤©åŒºåŸŸ -->
        <div class="chat-area">
            <div class="chat-header">
                <div class="chat-header-left">
                    <div class="channel-info">
                        <span class="channel-hash">#</span>
                        <span class="channel-name" id="currentChannel"></span>
                        <span class="channel-description" id="channelDescription"></span>
                    </div>
                </div>
                <div class="chat-header-right">
                    <div class="search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="æœç´¢æ¶ˆæ¯..." />
                    </div>
                    <!-- è¯­è¨€åˆ‡æ¢æŒ‰é’® -->
                    <div class="language-switcher">
                        <button class="lang-btn" onclick="switchLanguage('zh')" id="zhBtn">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</button>
                        <button class="lang-btn" onclick="switchLanguage('en')" id="enBtn">ğŸ‡¬ğŸ‡§ English</button>
                    </div>
                    <i class="fas fa-bell-slash header-icon" title="é™éŸ³é€šçŸ¥"></i>
                    <i class="fas fa-bell header-icon" title="é€šçŸ¥è®¾ç½®"></i>
                    <i class="fas fa-thumbtack header-icon" title="ç½®é¡¶æ¶ˆæ¯"></i>
                    <i class="fas fa-users header-icon" title="æˆå‘˜åˆ—è¡¨" onclick="toggleMemberList()"></i>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div style="text-align: center; padding: 40px; color: #96989d;">
                    <i class="fas fa-comments" style="font-size: 48px; margin-bottom: 20px;"></i>
                    <p id="startChattingText">å¼€å§‹èŠå¤©å§ï¼</p>
                </div>
            </div>

            <div class="chat-input">
                <div class="input-container">
                    <div class="input-actions">
                        <i class="fas fa-plus input-action-btn" title="æ·»åŠ é™„ä»¶"></i>
                    </div>
                    
                    <textarea 
                        class="message-input" 
                        id="messageInput" 
                        placeholder="Message #general"
                        rows="1"
                        onkeydown="handleKeyDown(event)"
                    ></textarea>
                    <div class="input-right-actions">
                        <i class="fas fa-gift input-action-btn" title="ç¤¼ç‰©"></i>
                        <i class="fas fa-image input-action-btn" title="GIF"></i>
                        <i class="fas fa-sticky-note input-action-btn" title="è´´çº¸"></i>
                        <i class="fas fa-smile input-action-btn" title="è¡¨æƒ…"></i>
                        <i class="fas fa-gamepad input-action-btn" title="æ¸¸æˆæ´»åŠ¨"></i>
                        <button class="send-button" onclick="sendMessage()" id="sendButton">
                            <i class="fas fa-paper-plane"></i>
                        </button>
            </div>
        </div>

            </div>
            <!-- ç»Ÿè®¡é¢æ¿ - æš‚æ—¶éšè— -->
            <!--
    <div class="stats-panel" id="statsPanel">
        <div class="stats-title">å®æ—¶ç»Ÿè®¡</div>
        <div class="stats-item">
            <span class="stats-label">æ€»æ¶ˆæ¯æ•°:</span>
            <span class="stats-value" id="totalMessages">0</span>
        </div>
        <div class="stats-item">
            <span class="stats-label">å¥³æ€§æ¶ˆæ¯:</span>
            <span class="stats-value" id="femaleMessages">0 (0%)</span>
        </div>
        <div class="stats-item">
            <span class="stats-label">ç”·æ€§æ¶ˆæ¯:</span>
            <span class="stats-value" id="maleMessages">0 (0%)</span>
        </div>
        <div class="stats-item">
            <span class="stats-label">æ£€æµ‹åˆ°æ‰“æ–­:</span>
            <span class="stats-value" id="interruptions">0æ¬¡</span>
        </div>
        <div class="stats-item">
            <span class="stats-label">å¹²é¢„æ¬¡æ•°:</span>
            <span class="stats-value" id="interventions">0æ¬¡</span>
                </div>
            </div>
            -->
        </div>

        <!-- ç”¨æˆ·åˆ—è¡¨ä¾§è¾¹æ  -->
        <div class="users-panel" id="usersPanel">
            <div class="users-header" id="usersHeader">
                æˆå‘˜åˆ—è¡¨
                <div class="online-count" id="onlineCount">åœ¨çº¿ - 0 | ç¦»çº¿ - 0</div>
            </div>
            <div class="user-list" id="userList">
                <!-- ç”¨æˆ·åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <script>
        let socket = null;
        let currentUser = null;
        let currentRoomId = null;
        let currentLanguage = 'zh';
        let translations = {};
        let stats = {
            totalMessages: 0,
            femaleMessages: 0,
            maleMessages: 0,
            interruptions: 0,
            interventions: 0
        };

        // è·å–æˆ¿é—´ID
        const roomId = window.location.pathname.split('/').pop();

        // åˆå§‹åŒ–
        window.onload = function() {
            console.log('é¡µé¢å¼€å§‹åˆå§‹åŒ–...');
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const token = localStorage.getItem('token');
            if (!token) {
                console.log('æœªæ‰¾åˆ°ç™»å½•tokenï¼Œè·³è½¬åˆ°é¦–é¡µ');
                window.location.href = '/';
                return;
            }

            // åŠ è½½ä¿å­˜çš„è¯­è¨€è®¾ç½®
            const savedLanguage = localStorage.getItem('language') || 'zh';
            console.log('åŠ è½½ä¿å­˜çš„è¯­è¨€è®¾ç½®:', savedLanguage);
            
            // å…ˆè®¾ç½®è¯­è¨€ï¼Œå†åŠ è½½å…¶ä»–å†…å®¹
            switchLanguage(savedLanguage).then(() => {
                console.log('è¯­è¨€åˆ‡æ¢å®Œæˆï¼Œå¼€å§‹åŠ è½½å…¶ä»–å†…å®¹');
                
                currentRoomId = roomId;
                console.log('å½“å‰æˆ¿é—´ID:', currentRoomId);
                
                // è·å–ç”¨æˆ·ä¿¡æ¯
                loadUserInfo();
                
                // åŠ è½½æˆ¿é—´ä¿¡æ¯
                loadRoomInfo();
                
                // è¿æ¥WebSocket
                connectWebSocket();
                
                // åŠ è½½åˆå§‹æ•°æ®
                loadMessages();
                loadUsers();
                loadStats();
                
                // åŠ è½½ä¿å­˜çš„é£æ ¼å¹¶åŒæ­¥TKIæ§åˆ¶é¢æ¿
                loadSavedInterventionStyle().then(() => {
                    // ç¡®ä¿é£æ ¼æ˜¾ç¤ºåœ¨é¡µé¢åŠ è½½æ—¶æ­£ç¡®æ˜¾ç¤º
                    setTimeout(() => {
                        loadSavedInterventionStyle();
                    }, 1000);
                });
                
                // é¡µé¢åˆå§‹åŒ–å®Œæˆåï¼Œå®šæœŸåˆ·æ–°æˆå‘˜åˆ—è¡¨
                setInterval(() => {
                    console.log('å®šæ—¶åˆ·æ–°æˆå‘˜åˆ—è¡¨...');
                    loadUsers();
                }, 5000); // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡
                
                // å…¨å±€é¼ æ ‡äº‹ä»¶ç›‘å¬å™¨ï¼Œç¡®ä¿tooltipæ­£ç¡®éšè—
                document.addEventListener('mouseover', (event) => {
                    // å¦‚æœé¼ æ ‡ä¸åœ¨ç”¨æˆ·å¤´åƒä¸Šï¼Œéšè—tooltip
                    if (!event.target.closest('.user-avatar')) {
                        hideUserTooltip();
                    }
                });
                
                console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            });
        };

        // é¡µé¢äº‹ä»¶ç›‘å¬å™¨
        window.addEventListener('beforeunload', () => {
            console.log('é¡µé¢å³å°†å…³é—­ï¼Œç¦»å¼€æˆ¿é—´');
            if (socket) {
                socket.emit('leave_room', { room: String(currentRoomId) });
            }
        });

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('é¡µé¢éšè—ï¼Œç¦»å¼€æˆ¿é—´');
                if (socket) {
                    socket.emit('leave_room', { room: String(currentRoomId) });
                }
            } else {
                console.log('é¡µé¢æ˜¾ç¤ºï¼Œé‡æ–°åŠ å…¥æˆ¿é—´');
                if (socket) {
                    socket.emit('join_room', { room: String(currentRoomId) });
                }
            }
        });

        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/user/info', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                if (response.ok) {
                    currentUser = await response.json();
                    updateCurrentUserDisplay();
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // æ›´æ–°å½“å‰ç”¨æˆ·æ˜¾ç¤º
        function updateCurrentUserDisplay() {
            if (!currentUser) return;
            
            const sidebarAvatarElement = document.getElementById('sidebarUserAvatar');
            const sidebarNameElement = document.getElementById('sidebarUserName');
            const sidebarInitialElement = document.getElementById('sidebarUserInitial');
            
            if (sidebarAvatarElement && sidebarNameElement && sidebarInitialElement) {
                // æ›´æ–°ç”¨æˆ·å
                const displayName = currentUser.display_name || currentUser.username;
                sidebarNameElement.textContent = displayName;
                
                // æ›´æ–°å¤´åƒ
                if (currentUser.avatar) {
                    sidebarAvatarElement.innerHTML = `<img src="${currentUser.avatar}" alt="${displayName}">`;
                } else {
                    // å¦‚æœæ²¡æœ‰å¤´åƒï¼Œæ˜¾ç¤ºç”¨æˆ·åé¦–å­—æ¯
                    const initial = displayName.charAt(0).toUpperCase();
                    sidebarInitialElement.textContent = initial;
                    sidebarAvatarElement.innerHTML = `<span id="sidebarUserInitial">${initial}</span>`;
                }
                
                console.log('ä¾§è¾¹æ ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°:', displayName);
            }
        }

        // åŠ è½½æˆ¿é—´ä¿¡æ¯
        async function loadRoomInfo() {
            try {
                const response = await fetch(`/api/rooms/${currentRoomId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const room = await response.json();
                    console.log('æˆ¿é—´ä¿¡æ¯:', room);
                    
                    // æ›´æ–°æˆ¿é—´åç§°
                    const roomNameElement = document.querySelector('.room-name');
                    if (roomNameElement) {
                        roomNameElement.textContent = room.name;
                    }
                    
                    // æ›´æ–°æˆ¿é—´æè¿° - ä½¿ç”¨ç¿»è¯‘
                    const roomDescriptionElement = document.querySelector('.room-description');
                    if (roomDescriptionElement) {
                        if (room.description && room.description.trim()) {
                            roomDescriptionElement.textContent = room.description;
                        } else {
                            roomDescriptionElement.textContent = t('no_description');
                        }
                    }
                } else if (response.status === 404) {
                    // æˆ¿é—´ä¸å­˜åœ¨ï¼Œè·³è½¬åˆ°é”™è¯¯é¡µé¢
                    window.location.href = '/rooms';
                } else {
                    console.error('åŠ è½½æˆ¿é—´ä¿¡æ¯å¤±è´¥:', response.status);
                }
            } catch (error) {
                console.error('åŠ è½½æˆ¿é—´ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // è¿æ¥WebSocket
        function connectWebSocket() {
            console.log('å¼€å§‹è¿æ¥WebSocket...');
            const token = localStorage.getItem('token');
            socket = io(`?token=${encodeURIComponent(token)}`);
            
            socket.on('connect', () => {
                console.log('WebSocketè¿æ¥æˆåŠŸï¼Œæˆ¿é—´ID:', currentRoomId);
                console.log('Socket ID:', socket.id);
                
                // ç«‹å³åŠ å…¥æˆ¿é—´
                socket.emit('join_room', { room: String(currentRoomId) });
                console.log('å·²å‘é€åŠ å…¥æˆ¿é—´äº‹ä»¶');
                
                // å‘é€ä¸€ä¸ªæµ‹è¯•äº‹ä»¶
                setTimeout(() => {
                    console.log('å‘é€æµ‹è¯•äº‹ä»¶...');
                    socket.emit('test', { message: 'å‰ç«¯æµ‹è¯•æ¶ˆæ¯' });
                }, 1000);
            });

            socket.on('disconnect', () => {
                console.log('WebSocketè¿æ¥æ–­å¼€');
            });

            socket.on('connect_error', (error) => {
                console.error('WebSocketè¿æ¥é”™è¯¯:', error);
            });

            // æ¶ˆæ¯ç›‘å¬å™¨
            socket.on('message', (data) => {
                console.log('æ”¶åˆ°æ¶ˆæ¯:', data);
                console.log('æ¶ˆæ¯ç±»å‹:', typeof data);
                console.log('æ¶ˆæ¯å†…å®¹:', JSON.stringify(data));
                console.log('è°ƒç”¨addMessageå‡½æ•°...');
                
                // ä½¿ç”¨addMessageå‡½æ•°æ¥æ­£ç¡®æ˜¾ç¤ºæ¶ˆæ¯
                addMessage(data);
                console.log('addMessageå‡½æ•°è°ƒç”¨å®Œæˆ');
            });

            socket.on('user_joined', (data) => {
                console.log('æ”¶åˆ°user_joined', data);
                console.log('ç«‹å³è°ƒç”¨loadUsers()...');
                // ç«‹å³é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨
                loadUsers();
                console.log('loadUsers()è°ƒç”¨å®Œæˆ');
            });

            socket.on('user_left', (data) => {
                console.log('æ”¶åˆ°user_left', data);
                console.log('ç«‹å³è°ƒç”¨loadUsers()...');
                // ç«‹å³é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨
                loadUsers();
                console.log('loadUsers()è°ƒç”¨å®Œæˆ');
            });

            socket.on('intervention', (data) => {
                console.log('æ”¶åˆ°å¹²é¢„æ¶ˆæ¯:', data);
                addIntervention(data);
                updateStats();
            });

            // æµ‹è¯•äº‹ä»¶ç›‘å¬å™¨ï¼ˆå·²ç§»é™¤å¼¹çª—ï¼‰
            socket.on('test', (data) => {
                console.log('æ”¶åˆ°æµ‹è¯•æ¶ˆæ¯:', data);
            });
            
            // TKIé£æ ¼æ›´æ–°äº‹ä»¶ç›‘å¬å™¨ï¼ˆæˆ¿é—´å†…å¹¿æ’­ï¼‰
            socket.on('tki_style_updated', (data) => {
                console.log('æ”¶åˆ°TKIé£æ ¼æ›´æ–°:', data);
                updateTKIStyleDisplay(data);
                // åŒæ—¶æ›´æ–°å½“å‰é£æ ¼æ˜¾ç¤º
                updateCurrentInterventionStyle(data.style);
            });

            // å¹²é¢„é£æ ¼æ›´æ–°äº‹ä»¶ç›‘å¬å™¨ï¼ˆå…¨å±€å¹¿æ’­ï¼‰
            socket.on('intervention_style_updated', (data) => {
                console.log('æ”¶åˆ°å¹²é¢„é£æ ¼æ›´æ–°:', data);
                updateCurrentInterventionStyle(data.style);
                // åŒæ—¶åŒæ­¥TKIæ§åˆ¶é¢æ¿ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰
                const tkiStyleSelect = document.getElementById('tkiStyle');
                if (tkiStyleSelect && currentUser && currentUser.role === 'admin') {
                    tkiStyleSelect.value = data.style;
                    onTKIStyleChange();
                }
            });

            console.log('WebSocketäº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®å®Œæˆ');
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content) return;

            console.log('å¼€å§‹å‘é€æ¶ˆæ¯:', content);
            console.log('å½“å‰ç”¨æˆ·:', currentUser);
            console.log('WebSocketçŠ¶æ€:', socket ? 'å·²è¿æ¥' : 'æœªè¿æ¥');
            console.log('æˆ¿é—´ID:', currentRoomId);
            console.log('Socket ID:', socket ? socket.id : 'æ— ');

            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;

            try {
                const messageData = {
                    content: content,
                    gender: currentUser.gender || 'unknown'
                };

                console.log('æ¶ˆæ¯æ•°æ®:', messageData);

                // é€šè¿‡WebSocketå‘é€æ¶ˆæ¯
                if (socket) {
                    const emitData = {
                        room: String(currentRoomId),
                        message: messageData
                    };
                    console.log('å‘é€WebSocketäº‹ä»¶:', emitData);
                    socket.emit('send_message', emitData);
                    input.value = '';
                    console.log('æ¶ˆæ¯å·²å‘é€åˆ°WebSocket');
                    
                    // ç­‰å¾…ä¸€ä¸‹çœ‹çœ‹æ˜¯å¦æ”¶åˆ°å›å¤
                    setTimeout(() => {
                        console.log('3ç§’åæ£€æŸ¥æ˜¯å¦æ”¶åˆ°æ¶ˆæ¯...');
                    }, 3000);
                } else {
                    console.error('WebSocketæœªè¿æ¥');
                }
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
            } finally {
                sendButton.disabled = false;
            }
        }

        // å¤„ç†é”®ç›˜äº‹ä»¶
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
        function addMessage(data) {
            try {
            const messagesContainer = document.getElementById('chatMessages');
                if (!messagesContainer) {
                    console.error('æ‰¾ä¸åˆ°æ¶ˆæ¯å®¹å™¨å…ƒç´ ');
                    return;
                }
            
            // æ¸…é™¤æ¬¢è¿æ¶ˆæ¯
            if (messagesContainer.children.length === 1 && 
                messagesContainer.children[0].querySelector('.fa-comments')) {
                messagesContainer.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
                
                // ä½¿ç”¨ç”¨æˆ·å¤´åƒæˆ–é»˜è®¤å¤´åƒ
                if (data.avatar && data.avatar.trim() !== '') {
                    const img = document.createElement('img');
                    img.src = data.avatar;
                    img.alt = data.author;
                    img.onerror = function() {
                        // å¦‚æœå¤´åƒåŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºç”¨æˆ·åé¦–å­—æ¯
            avatar.textContent = data.author.charAt(0).toUpperCase();
                    };
                    avatar.appendChild(img);
                } else {
                    // æ²¡æœ‰å¤´åƒæ—¶æ˜¾ç¤ºç”¨æˆ·åé¦–å­—æ¯
                    avatar.textContent = data.author.charAt(0).toUpperCase();
                }
            
            const content = document.createElement('div');
            content.className = 'message-content';
            
            const header = document.createElement('div');
            header.className = 'message-header';
            
            const author = document.createElement('span');
            author.className = 'message-author';
            author.textContent = data.author;
            
            const timestamp = document.createElement('span');
            timestamp.className = 'message-timestamp';
                // æ˜¾ç¤ºæœ¬åœ°æ—¶é—´ï¼Œæ ¼å¼ä¸º HH:MM:SS
                const localTime = new Date(data.timestamp).toLocaleTimeString('zh-CN', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                timestamp.textContent = localTime;
            
            header.appendChild(author);
            header.appendChild(timestamp);
            
            const text = document.createElement('div');
            text.className = 'message-text';
            text.textContent = data.content;
            
            content.appendChild(header);
            content.appendChild(text);
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // æ›´æ–°ç»Ÿè®¡
            stats.totalMessages++;
            updateStats();
            } catch (error) {
                console.error('æ·»åŠ æ¶ˆæ¯æ—¶å‡ºé”™:', error);
            }
        }

        // æ·»åŠ å¹²é¢„æ¶ˆæ¯
        function addIntervention(data) {
            const messagesContainer = document.getElementById('chatMessages');
            const interventionDiv = document.createElement('div');
            interventionDiv.className = 'message';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = '<i class="fas fa-robot"></i>';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            
            const header = document.createElement('div');
            header.className = 'message-header';
            
            const author = document.createElement('span');
            author.className = 'message-author';
            author.textContent = 'TKIå¹²é¢„æœºå™¨äºº';
            
            const timestamp = document.createElement('span');
            timestamp.className = 'message-timestamp';
            // æ˜¾ç¤ºæœ¬åœ°æ—¶é—´ï¼Œæ ¼å¼ä¸º HH:MM:SS
            const localTime = new Date(data.timestamp).toLocaleTimeString('zh-CN', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            timestamp.textContent = localTime;
            
            header.appendChild(author);
            header.appendChild(timestamp);
            
            const interventionContent = document.createElement('div');
            interventionContent.className = 'intervention-message';
            
            const strategy = document.createElement('div');
            strategy.className = 'strategy';
            strategy.textContent = `å¹²é¢„ç­–ç•¥: ${data.strategy}`;
            
            const text = document.createElement('div');
            text.className = 'message-text';
            text.textContent = data.text;
            
            interventionContent.appendChild(strategy);
            interventionContent.appendChild(text);
            
            content.appendChild(header);
            content.appendChild(interventionContent);
            
            interventionDiv.appendChild(avatar);
            interventionDiv.appendChild(content);
            
            messagesContainer.appendChild(interventionDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // æ›´æ–°ç»Ÿè®¡
            stats.interventions++;
            updateStats();
        }

        // åŠ è½½æ¶ˆæ¯å†å²
        async function loadMessages() {
            try {
                const response = await fetch(`/api/rooms/${currentRoomId}/messages`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const messages = await response.json();
                    const messagesContainer = document.getElementById('chatMessages');
                    messagesContainer.innerHTML = '';
                    
                    messages.forEach(msg => {
                        addMessage(msg);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
            }
        }

        // åŠ è½½æˆ¿é—´æˆå‘˜åˆ—è¡¨
        async function loadUsers() {
            console.log('å¼€å§‹åŠ è½½ç”¨æˆ·åˆ—è¡¨ï¼Œæˆ¿é—´ID:', currentRoomId);
            try {
                // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                const timestamp = new Date().getTime();
                const response = await fetch(`/api/rooms/${currentRoomId}/members?t=${timestamp}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Cache-Control': 'no-cache'
                    }
                });
                
                console.log('APIå“åº”çŠ¶æ€:', response.status);
                console.log('APIå“åº”å¤´:', response.headers);
                
                if (response.ok) {
                    const members = await response.json();
                    console.log('åŠ è½½åˆ°çš„æˆå‘˜:', members);
                    console.log('æˆå‘˜æ•°é‡:', members.length);
                    console.log('æˆå‘˜è¯¦æƒ…:', JSON.stringify(members, null, 2));
                    
                    displayUsers(members);
                } else {
                    console.error('åŠ è½½æˆ¿é—´æˆå‘˜å¤±è´¥:', response.status, response.statusText);
                    const responseText = await response.text();
                    console.error('é”™è¯¯å“åº”å†…å®¹:', responseText);
                    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    const userList = document.getElementById('userList');
                    if (userList) {
                        userList.innerHTML = '<div style="padding: 20px; text-align: center; color: #f04747; font-size: 14px;">åŠ è½½æˆå‘˜å¤±è´¥</div>';
                    } else {
                        console.error('æ‰¾ä¸åˆ°userListå…ƒç´ ');
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æˆ¿é—´æˆå‘˜å¤±è´¥:', error);
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const userList = document.getElementById('userList');
                if (userList) {
                    userList.innerHTML = '<div style="padding: 20px; text-align: center; color: #f04747; font-size: 14px;">ç½‘ç»œé”™è¯¯</div>';
                } else {
                    console.error('æ‰¾ä¸åˆ°userListå…ƒç´ ');
                }
            }
        }

        // æ˜¾ç¤ºæˆ¿é—´æˆå‘˜åˆ—è¡¨
        function displayUsers(members) {
            console.log('å¼€å§‹æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨ï¼Œæˆå‘˜æ•°é‡:', members.length);
            const userList = document.getElementById('userList');
            if (!userList) {
                console.error('æ‰¾ä¸åˆ°userListå…ƒç´ ');
                return;
            }
            
            console.log('æ‰¾åˆ°userListå…ƒç´ ï¼Œå¼€å§‹å¤„ç†æˆå‘˜æ•°æ®');
            
            // ç®€åŒ–é€»è¾‘ï¼šåªè¦åœ¨æˆ¿é—´ä¸­å°±æ˜¾ç¤ºä¸ºåœ¨çº¿
            const onlineUsers = members.filter(member => member.is_online);
            const offlineUsers = members.filter(member => !member.is_online);
            
            console.log('åœ¨çº¿ç”¨æˆ·æ•°:', onlineUsers.length, 'ç¦»çº¿ç”¨æˆ·æ•°:', offlineUsers.length);
            
            // æ›´æ–°åœ¨çº¿äººæ•°æ˜¾ç¤º
            const onlineCountElement = document.getElementById('onlineCount');
            if (onlineCountElement) {
                onlineCountElement.innerHTML = `${t('members')}<div class="online-count">${t('online')} - ${onlineUsers.length} | ${t('offline')} - ${offlineUsers.length}</div>`;
                console.log('å·²æ›´æ–°åœ¨çº¿äººæ•°æ˜¾ç¤º');
            } else {
                console.error('æ‰¾ä¸åˆ°onlineCountå…ƒç´ ');
            }
            
            // æ¸…ç©ºç”¨æˆ·åˆ—è¡¨
            userList.innerHTML = '';
            console.log('å·²æ¸…ç©ºç”¨æˆ·åˆ—è¡¨');
            
            // å¦‚æœæ²¡æœ‰ç”¨æˆ·ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            if (members.length === 0) {
                console.log('æ²¡æœ‰æˆå‘˜ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
                const emptyMessage = document.createElement('div');
                emptyMessage.style.cssText = 'padding: 20px; text-align: center; color: #96989d; font-size: 14px;';
                emptyMessage.innerHTML = `<i class="fas fa-users" style="font-size: 24px; margin-bottom: 8px; display: block;"></i>${t('no_members')}`;
                userList.appendChild(emptyMessage);
                return;
            }
            
            // æ·»åŠ åœ¨çº¿ç”¨æˆ·
            if (onlineUsers.length > 0) {
                console.log('æ·»åŠ åœ¨çº¿ç”¨æˆ·æ ‡é¢˜');
                const onlineHeader = document.createElement('div');
                onlineHeader.className = 'user-section-header';
                onlineHeader.textContent = `${t('online')} - ${onlineUsers.length}`;
                onlineHeader.style.cssText = 'padding: 8px 16px; font-size: 12px; color: #96989d; font-weight: 600; background: #2f3136; border-bottom: 1px solid #202225;';
                userList.appendChild(onlineHeader);
                
                onlineUsers.forEach(member => {
                    addUserToList(member, true);
                });
            }
            
            // æ·»åŠ ç¦»çº¿ç”¨æˆ·
            if (offlineUsers.length > 0) {
                console.log('æ·»åŠ ç¦»çº¿ç”¨æˆ·æ ‡é¢˜');
                const offlineHeader = document.createElement('div');
                offlineHeader.className = 'user-section-header';
                offlineHeader.textContent = `${t('offline')} - ${offlineUsers.length}`;
                offlineHeader.style.cssText = 'padding: 8px 16px; font-size: 12px; color: #96989d; font-weight: 600; background: #2f3136; border-bottom: 1px solid #202225;';
                userList.appendChild(offlineHeader);
                
                offlineUsers.forEach(member => {
                    addUserToList(member, false);
                });
            }
        }

        // æ·»åŠ ç”¨æˆ·åˆ°åˆ—è¡¨
        function addUserToList(member, isOnline) {
            console.log('æ·»åŠ ç”¨æˆ·åˆ°åˆ—è¡¨:', member, 'åœ¨çº¿çŠ¶æ€:', isOnline);
            const userList = document.getElementById('userList');
            if (!userList) {
                console.error('æ‰¾ä¸åˆ°userListå…ƒç´ ');
                return;
            }
            
            const userDiv = document.createElement('div');
            userDiv.className = `user-item ${isOnline ? 'online' : 'offline'}`;
            userDiv.dataset.userId = member.user_id;
            
            const displayName = member.display_name || member.username;
            const statusClass = isOnline ? 'online' : 'offline';
            const statusText = isOnline ? t('online') : t('offline');
            
            console.log('ç”¨æˆ·ä¿¡æ¯:', {
                username: member.username,
                displayName: displayName,
                isOnline: isOnline,
                statusClass: statusClass,
                statusText: statusText,
                lastActivity: member.last_activity,
                isInRoom: member.is_in_room
            });
            
            // è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ï¼Œé˜²æ­¢XSS
            const safeUsername = member.username.replace(/[<>'"]/g, '');
            const safeDisplayName = displayName.replace(/[<>'"]/g, '');
            
            userDiv.innerHTML = `
                    <div class="user-avatar" 
                     onmouseenter="showUserTooltip(event, '${safeUsername}', '${safeDisplayName}', '${member.gender || 'unknown'}', '${member.role || 'member'}')"
                     onmouseleave="hideUserTooltip()"
                     onmouseout="hideUserTooltip()">
                    ${member.avatar ? `<img src="${member.avatar}" alt="${safeUsername}">` : safeUsername.charAt(0).toUpperCase()}
                    <div class="status-indicator ${statusClass}"></div>
                    </div>
                    <div class="user-info">
                    <div class="user-name">${safeDisplayName}</div>
                    <div class="user-status">${statusText}</div>
                    </div>
            `;
            
            userList.appendChild(userDiv);
            console.log('å·²æ·»åŠ ç”¨æˆ·åˆ°åˆ—è¡¨:', member.username);
        }

        // å®æ—¶æ›´æ–°ç”¨æˆ·çŠ¶æ€
        function updateUserStatus(userId, isOnline) {
            const userItem = document.querySelector(`[data-user-id="${userId}"]`);
            if (userItem) {
                const statusClass = isOnline ? 'online' : 'offline';
                const statusText = isOnline ? t('online') : t('offline');
                
                // æ›´æ–°ç”¨æˆ·é¡¹æ ·å¼
                userItem.className = `user-item ${statusClass}`;
                
                // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
                const statusIndicator = userItem.querySelector('.status-indicator');
                if (statusIndicator) {
                    statusIndicator.className = `status-indicator ${statusClass}`;
                }
                
                // æ›´æ–°çŠ¶æ€æ–‡æœ¬
                const statusTextElement = userItem.querySelector('.user-status');
                if (statusTextElement) {
                    statusTextElement.textContent = statusText;
                }
                
                console.log(`ç”¨æˆ· ${userId} çŠ¶æ€æ›´æ–°ä¸º: ${isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}`);
            }
        }

        // å®šæœŸåˆ·æ–°ç”¨æˆ·çŠ¶æ€
        function startUserStatusRefresh() {
            // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡ç”¨æˆ·çŠ¶æ€
            setInterval(() => {
                if (socket && socket.connected) {
                    console.log('å®šæœŸåˆ·æ–°ç”¨æˆ·çŠ¶æ€...');
                    loadUsers();
                }
            }, 5000);
        }

        // é¡µé¢åˆå§‹åŒ–å®Œæˆåå¯åŠ¨çŠ¶æ€åˆ·æ–°
        window.addEventListener('load', () => {
            startUserStatusRefresh();
        });

        // æ˜¾ç¤ºç”¨æˆ·æç¤º
        function showUserTooltip(event, username, displayName, gender, role) {
            const tooltip = document.createElement('div');
            tooltip.className = 'user-tooltip';
            tooltip.id = 'userTooltip';
            
            const genderText = gender === 'male' ? `â™‚ ${t('male')}` : gender === 'female' ? `â™€ ${t('female')}` : `? ${t('unknown')}`;
            const roleText = role === 'admin' ? t('admin') : t('member');
            const nameText = displayName ? `${displayName} (${username})` : username;
            
            tooltip.innerHTML = `
                <div><strong>${nameText}</strong></div>
                <div>${genderText}</div>
                <div>${roleText}</div>
            `;
            
            document.body.appendChild(tooltip);
            
            // å®šä½æç¤ºæ¡†
            const rect = event.target.getBoundingClientRect();
            tooltip.style.left = rect.left + 'px';
            tooltip.style.top = (rect.top - tooltip.offsetHeight - 10) + 'px';
            
            // æ˜¾ç¤ºæç¤ºæ¡†
            setTimeout(() => tooltip.classList.add('show'), 10);
        }

        // éšè—ç”¨æˆ·æç¤º
        function hideUserTooltip() {
            const tooltip = document.getElementById('userTooltip');
            if (tooltip) {
                tooltip.classList.remove('show');
                setTimeout(() => {
                    if (tooltip && tooltip.parentNode) {
                        tooltip.remove();
                    }
                }, 200);
            }
        }

        // æ·»åŠ ç”¨æˆ·åˆ°åˆ—è¡¨
        function addUser(userData) {
            const userList = document.getElementById('userList');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-item';
            userDiv.innerHTML = `
                <div class="user-avatar">${userData.username.charAt(0).toUpperCase()}</div>
                <div class="user-info">
                    <div class="user-name">${userData.username}</div>
                    <div class="user-status">åœ¨çº¿</div>
                </div>
                <div class="status-indicator"></div>
            `;
            userList.appendChild(userDiv);
            updateOnlineCount();
        }

        // ä»åˆ—è¡¨ä¸­ç§»é™¤ç”¨æˆ·
        function removeUser(userId) {
            const userItems = document.querySelectorAll('.user-item');
            userItems.forEach(item => {
                if (item.dataset.userId === userId) {
                    item.remove();
                }
            });
            updateOnlineCount();
        }

        // æ›´æ–°åœ¨çº¿äººæ•°
        function updateOnlineCount() {
            const userItems = document.querySelectorAll('.user-item');
            const count = userItems.length;
            document.getElementById('onlineCount').textContent = `${count}äººåœ¨çº¿`;
            document.getElementById('userCount').textContent = count;
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                const response = await fetch(`/api/stats/${currentRoomId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    stats = data;
                    updateStats();
                }
            } catch (error) {
                console.log('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
                // ä½¿ç”¨é»˜è®¤ç»Ÿè®¡
                stats = {
                    totalMessages: 0,
                    femaleMessages: 0,
                    maleMessages: 0,
                    interruptions: 0,
                    interventions: 0
                };
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        function updateStats() {
            try {
                const totalMessagesEl = document.getElementById('totalMessages');
                const femaleMessagesEl = document.getElementById('femaleMessages');
                const maleMessagesEl = document.getElementById('maleMessages');
                const interruptionsEl = document.getElementById('interruptions');
                const interventionsEl = document.getElementById('interventions');
                
                if (totalMessagesEl) totalMessagesEl.textContent = stats.totalMessages;
                if (femaleMessagesEl) femaleMessagesEl.textContent = 
                `${stats.femaleMessages} (${stats.femalePercentage || 0}%)`;
                if (maleMessagesEl) maleMessagesEl.textContent = 
                `${stats.maleMessages} (${stats.malePercentage || 0}%)`;
                if (interruptionsEl) interruptionsEl.textContent = `${stats.interruptions}æ¬¡`;
                if (interventionsEl) interventionsEl.textContent = `${stats.interventions}æ¬¡`;
            } catch (error) {
                console.log('æ›´æ–°ç»Ÿè®¡æ˜¾ç¤ºæ—¶å‡ºé”™:', error);
            }
        }

        // åˆ‡æ¢æˆå‘˜åˆ—è¡¨æ˜¾ç¤º
        function toggleMemberList() {
            const usersPanel = document.getElementById('usersPanel');
            if (usersPanel.style.display === 'none') {
                usersPanel.style.display = 'flex'; // Changed from 'block' to 'flex'
            } else {
                usersPanel.style.display = 'none';
            }
        }

        // TKIé£æ ¼é€‰æ‹©å˜åŒ–å¤„ç†å‡½æ•°
        function onTKIStyleChange() {
            const tkiStyle = document.getElementById('tkiStyle').value;
            const descriptionEl = document.getElementById('tkiStyleDescription');
            const confirmButton = document.getElementById('tkiConfirmButton');
            
            // å®šä¹‰å„ç§é£æ ¼çš„æè¿°
            const styleDescriptions = {
                'none': 'æ— æ’è¯ - AIä¸ä¼šè¿›è¡Œä»»ä½•å¹²é¢„',
                'collaborating': 'åä½œå‹ - æ•´åˆå„æ–¹è§‚ç‚¹ï¼Œæ¨åŠ¨å…±è¯†ï¼Œå¹³è¡¡æ”¯æŒå¥³æ€§è¡¨è¾¾ä¸ç»´æŠ¤ç¾¤ä½“å’Œè°',
                'accommodating': 'è¿å°±å‹ - ä¼˜å…ˆç»´æŠ¤å’Œè°ï¼Œç”¨æ¸©å’Œè¯­æ°”ä¸ºå¥³æ€§ç¼“é¢Šï¼Œé¿å…å†²çª',
                'competing': 'ç«äº‰å‹ - å¼ºåŠ¿æå«å¥³æ€§è¡¨è¾¾æƒï¼Œæ­£é¢å¯¹æŠ—åè§ï¼Œå¯èƒ½æ¿€åŒ–å†²çª',
                'compromising': 'å¦¥åå‹ - è®¾ç½®å…¬å¹³è®¨è®ºæœºåˆ¶ï¼Œä¿éšœå‘è¨€æœºä¼šï¼Œä¸å‚ä¸è§‚ç‚¹è¯„ä»·',
                'avoiding': 'å›é¿å‹ - å²”å¼€çŸ›ç›¾è¯é¢˜ï¼Œè¡¨é¢è½»æ¾ï¼Œå®åˆ™å‰Šå¼±å¥³æ€§è¡¨è¾¾æœºä¼š'
            };
            
            // æ›´æ–°æè¿°
            if (descriptionEl) {
                descriptionEl.textContent = styleDescriptions[tkiStyle] || 'é€‰æ‹©TKIæ’è¯é£æ ¼æ¥æ§åˆ¶AIçš„å¹²é¢„è¡Œä¸º';
            }
            
            // å¯ç”¨ç¡®è®¤æŒ‰é’®
            if (confirmButton) {
                confirmButton.disabled = false;
                confirmButton.textContent = `ç¡®è®¤æ›´æ¢ä¸º: ${document.getElementById('tkiStyle').options[document.getElementById('tkiStyle').selectedIndex].text}`;
            }
        }
        
        // TKIé£æ ¼ç¡®è®¤å‡½æ•°
        function confirmTKIStyleChange() {
            const tkiStyle = document.getElementById('tkiStyle').value;
            const confirmButton = document.getElementById('tkiConfirmButton');
            
            // ç¦ç”¨ç¡®è®¤æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            if (confirmButton) {
                confirmButton.disabled = true;
                confirmButton.textContent = 'æ­£åœ¨æ›´æ–°...';
            }
            
            // å‘é€é£æ ¼é€‰æ‹©åˆ°åç«¯
            if (socket) {
                socket.emit('tki_style_change', {
                    room: String(currentRoomId),
                    style: tkiStyle
                });
                console.log('TKIé£æ ¼å·²ç¡®è®¤æ›´æ”¹ä¸º:', tkiStyle);
            }
            
            // ç«‹å³æ›´æ–°å½“å‰é£æ ¼æ˜¾ç¤º
            updateCurrentInterventionStyle(tkiStyle);
            
            // æ˜¾ç¤ºç¡®è®¤æ¶ˆæ¯
            showNotification(`TKIé£æ ¼å·²æˆåŠŸè®¾ç½®ä¸º: ${document.getElementById('tkiStyle').options[document.getElementById('tkiStyle').selectedIndex].text}`);
            
            // é‡ç½®ç¡®è®¤æŒ‰é’®
            setTimeout(() => {
                if (confirmButton) {
                    confirmButton.textContent = 'ç¡®è®¤æ›´æ¢TKIæ’è¯é£æ ¼';
                    confirmButton.disabled = false;
                }
            }, 2000);
        }
        
        // æ›´æ–°TKIé£æ ¼æ˜¾ç¤º
        function updateTKIStyleDisplay(data) {
            const tkiStyleSelect = document.getElementById('tkiStyle');
            const descriptionEl = document.getElementById('tkiStyleDescription');
            
            if (tkiStyleSelect && descriptionEl) {
                // æ›´æ–°é€‰æ‹©æ¡†
                tkiStyleSelect.value = data.style;
                
                // æ›´æ–°æè¿°
                descriptionEl.textContent = data.description;
                
                console.log('TKIé£æ ¼æ˜¾ç¤ºå·²æ›´æ–°:', data.style);
            }
        }
        
        // æ›´æ–°å½“å‰å¹²é¢„é£æ ¼æ˜¾ç¤º
        function updateCurrentInterventionStyle(style) {
            const styleIndicatorDot = document.getElementById('styleIndicatorDot');
            const currentStyleText = document.getElementById('currentStyleText');
            
            // é£æ ¼é¢œè‰²æ˜ å°„
            const styleColors = {
                'none': '#747f8d',      // ç°è‰²
                'auto': '#747f8d',      // ç°è‰²
                'collaborating': '#5865f2',  // è“è‰²
                'accommodating': '#57f287',  // ç»¿è‰²
                'competing': '#ed4245',      // çº¢è‰²
                'compromising': '#faa61a',   // æ©™è‰²
                'avoiding': '#eb459e'        // ç²‰è‰²
            };
            
            // é£æ ¼æ˜¾ç¤ºåç§°æ˜ å°„
            const styleNames = {
                'none': 'æ— æ’è¯',
                'auto': 'è‡ªåŠ¨é€‰æ‹©',
                'collaborating': 'åä½œå‹',
                'accommodating': 'è¿å°±å‹',
                'competing': 'ç«äº‰å‹',
                'compromising': 'å¦¥åå‹',
                'avoiding': 'å›é¿å‹'
            };
            
            // æ›´æ–°é¢œè‰²å’Œæ–‡æœ¬
            if (styleIndicatorDot) {
                styleIndicatorDot.style.background = styleColors[style] || styleColors['collaborating'];
            }
            
            if (currentStyleText) {
                currentStyleText.textContent = styleNames[style] || styleNames['collaborating'];
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('currentInterventionStyle', style);
            
            console.log(`å¹²é¢„é£æ ¼å·²æ›´æ–°ä¸º: ${styleNames[style]}`);
        }

        // åŠ è½½ä¿å­˜çš„å¹²é¢„é£æ ¼
        function loadSavedInterventionStyle() {
            return new Promise((resolve) => {
                // é¦–å…ˆä»æœåŠ¡å™¨è·å–å½“å‰é£æ ¼
                fetch('/api/admin/current-intervention-style')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const serverStyle = data.style || 'collaborating';
                        updateCurrentInterventionStyle(serverStyle);
                        
                        // åŒæ­¥TKIæ§åˆ¶é¢æ¿çš„é€‰æ‹©ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰
                        const tkiStyleSelect = document.getElementById('tkiStyle');
                        if (tkiStyleSelect && currentUser && currentUser.role === 'admin') {
                            tkiStyleSelect.value = serverStyle;
                            // è§¦å‘æè¿°æ›´æ–°
                            onTKIStyleChange();
                        }
                        
                        // åŒæ—¶æ›´æ–°æœ¬åœ°å­˜å‚¨
                        localStorage.setItem('currentInterventionStyle', serverStyle);
                        
                        console.log(`ä»æœåŠ¡å™¨åŠ è½½å¹²é¢„é£æ ¼: ${serverStyle}`);
                        resolve(serverStyle);
                    })
                    .catch(error => {
                        console.error('ä»æœåŠ¡å™¨åŠ è½½é£æ ¼å¤±è´¥:', error);
                        // å¦‚æœæœåŠ¡å™¨è¯·æ±‚å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨çš„å¤‡ä»½
                        const savedStyle = localStorage.getItem('currentInterventionStyle');
                        if (savedStyle) {
                            updateCurrentInterventionStyle(savedStyle);
                            // åŒæ­¥TKIæ§åˆ¶é¢æ¿çš„é€‰æ‹©ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰
                            const tkiStyleSelect = document.getElementById('tkiStyle');
                            if (tkiStyleSelect && currentUser && currentUser.role === 'admin') {
                                tkiStyleSelect.value = savedStyle;
                                onTKIStyleChange();
                            }
                        } else {
                            // é»˜è®¤é£æ ¼
                            updateCurrentInterventionStyle('collaborating');
                            // åŒæ­¥TKIæ§åˆ¶é¢æ¿çš„é€‰æ‹©ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰
                            const tkiStyleSelect = document.getElementById('tkiStyle');
                            if (tkiStyleSelect && currentUser && currentUser.role === 'admin') {
                                tkiStyleSelect.value = 'collaborating';
                                onTKIStyleChange();
                            }
                        }
                        resolve(savedStyle || 'collaborating');
                    });
            });
        }

        // æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
        function showNotification(message) {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #5865f2;
                color: white;
                padding: 12px 16px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            // æ·»åŠ åŠ¨ç”»æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // è¯­è¨€åˆ‡æ¢åŠŸèƒ½
        async function switchLanguage(lang) {
            console.log('å¼€å§‹åˆ‡æ¢è¯­è¨€åˆ°:', lang);
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.getElementById(lang + 'Btn');
            if (activeBtn) {
                activeBtn.classList.add('active');
                console.log('è¯­è¨€æŒ‰é’®çŠ¶æ€å·²æ›´æ–°');
            }
            
            // åŠ è½½ç¿»è¯‘
            await loadTranslations(lang);
            console.log('ç¿»è¯‘åŠ è½½å®Œæˆ');
            
            // æ›´æ–°ç•Œé¢æ–‡æœ¬
            updateUIText();
            
            // é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨ä»¥æ›´æ–°çŠ¶æ€æ–‡æœ¬
            setTimeout(() => {
                loadUsers();
            }, 100);
            
            console.log('è¯­è¨€åˆ‡æ¢å®Œæˆ');
        }

        // åŠ è½½ç¿»è¯‘
        async function loadTranslations(lang) {
            try {
                const response = await fetch(`/api/translations/${lang}`);
                if (response.ok) {
                    translations = await response.json();
                } else {
                    translations = getBuiltInTranslations(lang);
                }
            } catch (error) {
                console.error('åŠ è½½ç¿»è¯‘å¤±è´¥:', error);
                translations = getBuiltInTranslations(lang);
            }
        }

        // è·å–å†…ç½®ç¿»è¯‘
        function getBuiltInTranslations(lang) {
            const translations = {
                zh: {
                    page_title: 'èŠå¤©æˆ¿é—´',
                    data_statistics: 'æ•°æ®ç»Ÿè®¡',
                    room_management: 'æˆ¿é—´ç®¡ç†',
                    return_home: 'è¿”å›é¦–é¡µ',
                    search_messages: 'æœç´¢æ¶ˆæ¯...',
                    mute_notifications: 'é™éŸ³é€šçŸ¥',
                    notification_settings: 'é€šçŸ¥è®¾ç½®',
                    pin_message: 'ç½®é¡¶æ¶ˆæ¯',
                    member_list: 'æˆå‘˜åˆ—è¡¨',
                    start_chatting: 'å¼€å§‹èŠå¤©å§ï¼',
                    message_placeholder: 'Message #general',
                    add_attachment: 'æ·»åŠ é™„ä»¶',
                    gift: 'ç¤¼ç‰©',
                    gif: 'GIF',
                    sticker: 'è´´çº¸',
                    emoji: 'è¡¨æƒ…',
                    game_activity: 'æ¸¸æˆæ´»åŠ¨',
                    send_message: 'å‘é€æ¶ˆæ¯',
                    members: 'æˆå‘˜åˆ—è¡¨',
                    online: 'åœ¨çº¿',
                    offline: 'ç¦»çº¿',
                    no_members: 'æš‚æ— æˆå‘˜',
                    no_description: 'æš‚æ— æè¿°',
                    loading_members_failed: 'åŠ è½½æˆå‘˜å¤±è´¥',
                    network_error: 'ç½‘ç»œé”™è¯¯',
                    male: 'ç”·æ€§',
                    female: 'å¥³æ€§',
                    unknown: 'æœªçŸ¥',
                    admin: 'ç®¡ç†å‘˜',
                    member: 'æˆå‘˜',
                    loading: 'åŠ è½½ä¸­...',
                    chinese: 'ä¸­æ–‡',
                    english: 'English'
                },
                en: {
                    page_title: 'Chat Room',
                    data_statistics: 'Data Statistics',
                    room_management: 'Room Management',
                    return_home: 'Return Home',
                    search_messages: 'Search messages...',
                    mute_notifications: 'Mute notifications',
                    notification_settings: 'Notification settings',
                    pin_message: 'Pin message',
                    member_list: 'Member list',
                    start_chatting: 'Start chatting!',
                    message_placeholder: 'Message #general',
                    add_attachment: 'Add attachment',
                    gift: 'Gift',
                    gif: 'GIF',
                    sticker: 'Sticker',
                    emoji: 'Emoji',
                    game_activity: 'Game activity',
                    send_message: 'Send message',
                    members: 'Members',
                    online: 'Online',
                    offline: 'Offline',
                    no_members: 'No members',
                    no_description: 'No description',
                    loading_members_failed: 'Failed to load members',
                    network_error: 'Network error',
                    male: 'Male',
                    female: 'Female',
                    unknown: 'Unknown',
                    admin: 'Admin',
                    member: 'Member',
                    loading: 'Loading...',
                    chinese: 'ä¸­æ–‡',
                    english: 'English'
                }
            };
            return translations[lang] || translations.zh;
        }

        // è·å–ç¿»è¯‘æ–‡æœ¬
        function t(key) {
            return translations[key] || key;
        }

        // æ›´æ–°ç•Œé¢æ–‡æœ¬
        function updateUIText() {
            console.log('å¼€å§‹æ›´æ–°ç•Œé¢æ–‡æœ¬ï¼Œå½“å‰è¯­è¨€:', currentLanguage);
            
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            document.title = t('page_title');
            
            // æ›´æ–°ä¾§è¾¹æ å¯¼èˆª
            const roomManagementNav = document.getElementById('roomManagementNav');
            const returnHomeNav = document.getElementById('returnHomeNav');
            if (roomManagementNav) roomManagementNav.textContent = t('room_management');
            if (returnHomeNav) returnHomeNav.textContent = t('return_home');
            
            // æ›´æ–°ç”¨æˆ·çŠ¶æ€
            const sidebarUserStatus = document.getElementById('sidebarUserStatus');
            if (sidebarUserStatus) sidebarUserStatus.textContent = t('online');
            
            // æ›´æ–°æˆ¿é—´æè¿° - å¦‚æœæ²¡æœ‰æè¿°ï¼Œæ˜¾ç¤ºç¿»è¯‘åçš„"æš‚æ— æè¿°"
            const roomDescriptionElement = document.querySelector('.room-description');
            if (roomDescriptionElement && (!roomDescriptionElement.textContent || roomDescriptionElement.textContent === 'æš‚æ— æè¿°')) {
                roomDescriptionElement.textContent = t('no_description');
            }
            
            // æ›´æ–°æœç´¢æ¡†å ä½ç¬¦
            const searchInput = document.querySelector('.search-bar input');
            if (searchInput) {
                searchInput.placeholder = t('search_messages');
                console.log('æœç´¢æ¡†å ä½ç¬¦å·²æ›´æ–°ä¸º:', t('search_messages'));
            }
            
            // æ›´æ–°å›¾æ ‡æ ‡é¢˜
            const bellSlashIcon = document.querySelector('.fa-bell-slash');
            const bellIcon = document.querySelector('.fa-bell');
            const thumbtackIcon = document.querySelector('.fa-thumbtack');
            const usersIcon = document.querySelector('.fa-users');
            
            if (bellSlashIcon) bellSlashIcon.title = t('mute_notifications');
            if (bellIcon) bellIcon.title = t('notification_settings');
            if (thumbtackIcon) thumbtackIcon.title = t('pin_message');
            if (usersIcon) usersIcon.title = t('member_list');
            
            // æ›´æ–°æ¬¢è¿æ¶ˆæ¯
            const startChattingText = document.getElementById('startChattingText');
            if (startChattingText) {
                startChattingText.textContent = t('start_chatting');
            }
            
            // æ›´æ–°è¾“å…¥æ¡†å ä½ç¬¦
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.placeholder = t('message_placeholder');
                console.log('æ¶ˆæ¯è¾“å…¥æ¡†å ä½ç¬¦å·²æ›´æ–°ä¸º:', t('message_placeholder'));
            }
            
            // æ›´æ–°è¾“å…¥æ“ä½œæŒ‰é’®æ ‡é¢˜
            const plusIcon = document.querySelector('.fa-plus');
            const giftIcon = document.querySelector('.fa-gift');
            const imageIcon = document.querySelector('.fa-image');
            const stickyNoteIcon = document.querySelector('.fa-sticky-note');
            const smileIcon = document.querySelector('.fa-smile');
            const gamepadIcon = document.querySelector('.fa-gamepad');
            const sendButton = document.getElementById('sendButton');
            
            if (plusIcon) plusIcon.title = t('add_attachment');
            if (giftIcon) giftIcon.title = t('gift');
            if (imageIcon) imageIcon.title = t('gif');
            if (stickyNoteIcon) stickyNoteIcon.title = t('sticker');
            if (smileIcon) smileIcon.title = t('emoji');
            if (gamepadIcon) gamepadIcon.title = t('game_activity');
            if (sendButton) sendButton.title = t('send_message');
            
            // æ›´æ–°æˆå‘˜åˆ—è¡¨æ ‡é¢˜
            const usersHeader = document.getElementById('usersHeader');
            if (usersHeader) {
                usersHeader.innerHTML = `${t('members')}<div class="online-count" id="onlineCount">${t('online')} - 0 | ${t('offline')} - 0</div>`;
                console.log('æˆå‘˜åˆ—è¡¨æ ‡é¢˜å·²æ›´æ–°ä¸º:', t('members'));
            }
            
            // æ›´æ–°è¯­è¨€æŒ‰é’®æ–‡æœ¬
            const zhBtn = document.getElementById('zhBtn');
            const enBtn = document.getElementById('enBtn');
            if (zhBtn) zhBtn.innerHTML = ` ${t('chinese')}`;
            if (enBtn) enBtn.innerHTML = ` ${t('english')}`;
            
            console.log('ç•Œé¢æ–‡æœ¬æ›´æ–°å®Œæˆï¼Œå½“å‰è¯­è¨€:', currentLanguage);
        }
    </script>
</body>
</html> 